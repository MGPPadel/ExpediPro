<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AbogApp - Gestión de Casos y Vencimientos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #111827; }
    .modal-content { max-height: 85vh; overflow-y: auto; transform-origin: center top; }
    .toast { position: fixed; bottom: 20px; right: 20px; color: white; padding: 12px 18px; border-radius: 10px; opacity: 0; transform: translateY(8px); transition: opacity .25s ease, transform .25s ease; z-index: 60; pointer-events: none; }
    .toast.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .toast.success { background: #16a34a; }
    .toast.error { background: #dc2626; }
    .toast.warn { background: #d97706; }
    .input-error { color: #fb7185; font-size: .85rem; margin-top: .25rem; }
    .modal-card { transition: transform .18s ease, opacity .18s ease; transform: translateY(-8px) scale(.995); opacity: 0; }
    .modal-enter { transform: translateY(0) scale(1); opacity: 1; }
    .modal-exit { transform: translateY(-8px) scale(.995); opacity: 0; }
    tr.hover-row:hover { background-color: rgba(255,255,255,0.03); }
    .required-dot::after { content: " *"; color: #fb7185; margin-left: 2px; font-weight: 700; }
    #movement-list li { transition: background-color .15s ease, transform .12s ease; }
    #movement-list li:hover { transform: translateY(-2px); }
    .file-pill { background:#374151; color:#e5e7eb; padding:6px 10px; border-radius:8px; display:inline-flex; align-items:center; margin:4px; gap:8px; }
    .file-pill button { background:transparent; border:none; color:#f87171; font-weight:700; cursor:pointer; }
    .file-link { color:#93c5fd; text-decoration:underline; margin-right:8px; }
    .tab-btn { padding: 8px 16px; border-radius: 8px; font-weight: 500; transition: background-color .2s ease, color .2s ease; }
    .tab-btn.active { background-color: #374151; color: #f9fafb; }
    .tab-btn:not(.active) { color: #9ca3af; }
    .sortable-header { cursor: pointer; user-select: none; }
    .sortable-header:hover { color: #e5e7eb; }
    .sort-icon { display: inline-block; width: 1em; height: 1em; margin-left: 4px; opacity: 0.5; }
  </style>
</head>
<body class="text-gray-200">

  <div class="container mx-auto p-4 md:p-8">
    <!-- Pestañas de Navegación -->
    <div class="mb-6 flex items-center border-b border-gray-700">
      <div class="flex space-x-2">
        <button id="tab-casos" class="tab-btn active">Casos</button>
        <button id="tab-vencimientos" class="tab-btn">Vencimientos</button>
      </div>
    </div>

    <!-- Vista de Casos -->
    <div id="casos-view">
      <header class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">Gestión de Casos Jurídicos</h1>
        <button id="addCaseBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Agregar Caso</button>
      </header>
      <!-- Barra de Búsqueda -->
      <div class="mb-4">
        <input type="text" id="search-casos" placeholder="🔎 Buscar por expediente, carátula, fuero..." class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
      </div>
      <main class="bg-gray-800 rounded-lg shadow overflow-hidden">
        <table class="w-full text-sm text-left text-gray-400">
          <thead class="bg-gray-700 text-gray-300 uppercase text-xs">
            <tr>
              <th class="px-6 py-3 sortable-header" data-sort="expediente">N° Expediente <span class="sort-icon"></span></th>
              <th class="px-6 py-3 sortable-header" data-sort="caratula">Carátula <span class="sort-icon"></span></th>
              <th class="px-6 py-3 sortable-header" data-sort="fuero">Fuero <span class="sort-icon"></span></th>
              <th class="px-6 py-3 sortable-header" data-sort="juzgado">Juzgado <span class="sort-icon"></span></th>
              <th class="px-6 py-3 text-center">Acciones</th>
            </tr>
          </thead>
          <tbody id="case-list-body"></tbody>
        </table>
      </main>
    </div>

    <!-- Vista de Vencimientos -->
    <div id="vencimientos-view" class="hidden">
      <header class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">Gestión de Vencimientos</h1>
        <button id="addVencimientoBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Agregar Vencimiento</button>
      </header>
      <main class="bg-gray-800 rounded-lg shadow overflow-hidden">
        <table class="w-full text-sm text-left text-gray-400">
          <thead class="bg-gray-700 text-gray-300 uppercase text-xs">
            <tr>
              <th class="px-6 py-3">Título / Motivo</th>
              <th class="px-6 py-3">Expediente Vinculado</th>
              <th class="px-6 py-3">Fecha Vencimiento</th>
              <th class="px-6 py-3">Recordatorio</th>
              <th class="px-6 py-3 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody id="vencimiento-list-body"></tbody>
        </table>
      </main>
    </div>
  </div>

  <div id="toast" class="toast success">Acción realizada</div>

  <!-- Modal: Nuevo/Editar Caso -->
  <div id="case-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content p-6 modal-card">
      <div class="flex justify-between items-start mb-2">
        <h2 id="case-modal-title" class="text-xl font-bold text-white">Agregar Nuevo Caso</h2>
        <button id="x-case-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <form id="case-form" class="space-y-4">
        <input type="hidden" id="case-id">
        <div>
          <label class="block text-sm text-gray-300 required-dot">Actor</label>
          <input type="text" id="case-actor" placeholder="Actor" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Demandado</label>
          <input type="text" id="case-demandado" placeholder="Demandado" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">N° Expediente</label>
          <input type="text" id="case-expediente" placeholder="N° Expediente" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300">Objeto del juicio</label>
          <input type="text" id="case-objeto" placeholder="Objeto del juicio" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Fuero</label>
          <select id="case-fuero" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            <option value="" disabled selected>Seleccionar fuero</option>
            <option value="Laboral">Laboral</option>
            <option value="Civil">Civil</option>
            <option value="Familia">Familia</option>
            <option value="Penal">Penal</option>
            <option value="Otro">Otro</option>
          </select>
          <input type="text" id="case-fuero-otro" placeholder="Si es otro, especifique" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 hidden mt-2">
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Juzgado</label>
          <input type="text" id="case-juzgado" placeholder="Juzgado donde está radicado" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300">Provincia / Ciudad</label>
          <input type="text" id="case-provincia" placeholder="Provincia / Ciudad" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
        </div>
        <div>
          <label class="block text-sm text-gray-300">Abogado de la otra parte</label>
          <input type="text" id="case-abogado" placeholder="Abogado de la otra parte" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
        </div>
        <div>
          <label class="block text-sm text-gray-300">Teléfono del abogado</label>
          <input type="text" id="case-telefono" placeholder="Teléfono del abogado" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
        </div>
        <div class="flex justify-end space-x-4 pt-2">
          <button type="button" id="cancel-case-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Cancelar</button>
          <button type="submit" id="save-case-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Detalles del Caso -->
  <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl modal-content modal-card">
      <div class="p-8">
        <div class="flex justify-between items-start">
          <h2 class="text-2xl font-bold text-white mb-6">Detalles del Expediente</h2>
          <button id="close-details-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
        </div>
        <div id="details-content" class="space-y-2 text-gray-300"></div>

        <div class="mt-8 pt-6 border-t border-gray-700">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">Movimientos del Expediente</h3>
            <button id="add-movement-btn" type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
              ➕ Agregar Movimiento
            </button>
          </div>
          <ul id="movement-list" class="space-y-4"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Agregar/Editar Movimiento -->
  <div id="movement-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content p-6 modal-card">
      <div class="flex justify-between items-start mb-2">
        <h2 class="text-xl font-bold text-white" id="movement-modal-title">Agregar Movimiento</h2>
        <button id="x-movement-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <form id="movement-form" class="space-y-4">
        <div>
          <label class="block text-sm text-gray-300 required-dot">Fecha</label>
          <input type="date" id="mov-fecha" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Tipo</label>
          <select id="mov-tipo" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            <option value="" disabled selected>Seleccionar tipo</option>
            <option value="escrito">✍️ Escrito</option>
            <option value="decreto">📜 Decreto</option>
            <option value="sentencia">⚖️ Sentencia</option>
            <option value="otro">Otro</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Descripción</label>
          <input type="text" id="mov-descripcion" placeholder="Descripción corta" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300">Detalle</label>
          <textarea id="mov-detalle" rows="3" placeholder="Detalle o texto completo" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5"></textarea>
        </div>

        <div>
          <label class="block text-sm text-gray-300">Archivos (PDF) - puede seleccionar varios</label>
          <input type="file" id="mov-archivos" accept="application/pdf" multiple class="w-full text-gray-300 mt-1">
          <div id="file-preview" class="mt-2 flex flex-wrap"></div>
        </div>

        <div class="flex justify-end space-x-4 pt-2">
          <button type="button" id="cancel-movement-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Cancelar</button>
          <button type="submit" id="save-movement-btn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Detalle de un movimiento -->
  <div id="movement-detail-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-xl modal-content p-6 modal-card">
      <div class="flex justify-between items-start mb-4">
        <h2 class="text-xl font-bold text-white">Detalle del Movimiento</h2>
        <button id="close-movement-detail-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <div id="movement-detail-content" class="space-y-4 text-gray-300"></div>
      <div class="flex justify-end space-x-4 mt-4">
        <button id="edit-movement-btn" type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg">Editar</button>
        <button id="delete-movement-btn" type="button" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Agregar/Editar Vencimiento -->
  <div id="vencimiento-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content p-6 modal-card">
      <div class="flex justify-between items-start mb-2">
        <h2 class="text-xl font-bold text-white" id="vencimiento-modal-title">Agregar Vencimiento</h2>
        <button id="x-vencimiento-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <form id="vencimiento-form" class="space-y-4">
        <input type="hidden" id="vencimiento-id">
        <div>
          <label class="block text-sm text-gray-300 required-dot">Título / Motivo</label>
          <input type="text" id="vencimiento-titulo" placeholder="Ej: Audiencia preliminar" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Fecha del vencimiento</label>
          <input type="date" id="vencimiento-fecha" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300">Expediente vinculado (opcional)</label>
          <select id="vencimiento-caso-id" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
            <option value="">Ninguno</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Recordar con anticipación</label>
          <select id="vencimiento-recordatorio" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            <option value="" disabled selected>Seleccionar días</option>
            <option value="1">1 día antes</option>
            <option value="5">5 días antes</option>
            <option value="10">10 días antes</option>
          </select>
        </div>
        <div class="flex justify-end space-x-4 pt-2">
          <button type="button" id="cancel-vencimiento-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Cancelar</button>
          <button type="submit" id="save-vencimiento-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Guardar</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    // ---------- DATOS DE LA APLICACIÓN ----------
    let casos = [
      {id: 1, expediente: "123/25", actor: "Pérez", demandado: "García", objeto: "Cobro de pesos", fuero: "Civil", juzgado: "Juzgado 2", provincia: "CABA", abogado: "Dr. López", telefono: "123456789"},
      {id: 2, expediente: "456/25", actor: "López", demandado: "Martínez", objeto: "Despido", fuero: "Laboral", juzgado: "Juzgado 5", provincia: "Bs As", abogado: "Dr. Pérez", telefono: "987654321"}
    ];
    let movimientos = { 1: [], 2: [] };
    let vencimientos = [
      {id: 1, titulo: "Audiencia Testimonial", fecha: new Date(new Date().setDate(new Date().getDate() + 4)).toISOString().split('T')[0], casoId: 1, recordatorio: 5},
      {id: 2, titulo: "Presentar Escrito", fecha: new Date(new Date().setDate(new Date().getDate() + 9)).toISOString().split('T')[0], casoId: 2, recordatorio: 10},
      {id: 3, titulo: "Vencimiento de Plazo", fecha: new Date(new Date().setDate(new Date().getDate() + 1)).toISOString().split('T')[0], casoId: null, recordatorio: 1}
    ];

    // ---------- ESTADO DE LA UI ----------
    let currentCaseId = null;
    let currentMovementIndex = null;
    let caseMode = "create";
    let movementMode = "create";
    let vencimientoMode = "create";
    let keptFiles = []; 
    let newFiles = [];
    let sortConfig = { key: 'expediente', direction: 'ascending' };
    let searchQuery = '';

    // ---------- REFERENCIAS DOM ----------
    const toast = document.getElementById("toast");
    const tabCasos = document.getElementById("tab-casos");
    const tabVencimientos = document.getElementById("tab-vencimientos");
    const casosView = document.getElementById("casos-view");
    const vencimientosView = document.getElementById("vencimientos-view");
    const searchCasosInput = document.getElementById('search-casos');
    const caseListBody = document.getElementById("case-list-body");
    const addCaseBtn = document.getElementById("addCaseBtn");
    const caseModal = document.getElementById("case-modal");
    const xCaseBtn = document.getElementById("x-case-btn");
    const cancelCaseBtn = document.getElementById("cancel-case-btn");
    const caseForm = document.getElementById("case-form");
    const caseModalTitle = document.getElementById("case-modal-title");
    const detailsModal = document.getElementById("details-modal");
    const closeDetailsBtn = document.getElementById("close-details-btn");
    const detailsContent = document.getElementById("details-content");
    const addMovementBtn = document.getElementById("add-movement-btn");
    const movementList = document.getElementById("movement-list");
    const movementModal = document.getElementById("movement-modal");
    const xMovementBtn = document.getElementById("x-movement-btn");
    const cancelMovementBtn = document.getElementById("cancel-movement-btn");
    const movementForm = document.getElementById("movement-form");
    const movementModalTitle = document.getElementById("movement-modal-title");
    const movArchivosInput = document.getElementById("mov-archivos");
    const filePreview = document.getElementById("file-preview");
    const movementDetailModal = document.getElementById("movement-detail-modal");
    const closeMovementDetailBtn = document.getElementById("close-movement-detail-btn");
    const movementDetailContent = document.getElementById("movement-detail-content");
    const editMovementBtn = document.getElementById("edit-movement-btn");
    const deleteMovementBtn = document.getElementById("delete-movement-btn");
    const addVencimientoBtn = document.getElementById("addVencimientoBtn");
    const vencimientoListBody = document.getElementById("vencimiento-list-body");
    const vencimientoModal = document.getElementById("vencimiento-modal");
    const xVencimientoBtn = document.getElementById("x-vencimiento-btn");
    const cancelVencimientoBtn = document.getElementById("cancel-vencimiento-btn");
    const vencimientoForm = document.getElementById("vencimiento-form");
    const vencimientoModalTitle = document.getElementById("vencimiento-modal-title");
    const vencimientoCasoIdSelect = document.getElementById("vencimiento-caso-id");
    const casosThead = document.querySelector('#casos-view thead');

    // ---------- UTILIDADES ----------
    function anyModalOpen() { return ![caseModal, detailsModal, movementModal, movementDetailModal, vencimientoModal].every(m => m.classList.contains('hidden')); }
    function lockScroll() { document.body.style.overflow = 'hidden'; }
    function unlockScroll() { document.body.style.overflow = ''; }

    function openModal(el) {
      el.classList.remove('hidden');
      const card = el.querySelector('.modal-card');
      if (card) {
        card.classList.remove('modal-exit');
        requestAnimationFrame(() => card.classList.add('modal-enter'));
      }
      lockScroll();
    }

    function closeModal(el) {
      const card = el.querySelector('.modal-card');
      if (card) {
        card.classList.remove('modal-enter');
        card.classList.add('modal-exit');
        setTimeout(() => {
          el.classList.add('hidden');
          card.classList.remove('modal-exit');
          if (!anyModalOpen()) unlockScroll();
        }, 180);
      } else {
        el.classList.add('hidden');
        if (!anyModalOpen()) unlockScroll();
      }
    }

    [caseModal, detailsModal, movementModal, movementDetailModal, vencimientoModal].forEach(modal => {
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === "Escape") { [caseModal, detailsModal, movementModal, movementDetailModal, vencimientoModal].forEach(m => closeModal(m)); }
    });

    let toastTimeout = null;
    function showToast(msg = "Acción realizada", type = "success", ms = 2600) {
      toast.textContent = msg;
      toast.className = 'toast ' + type + ' show';
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, ms);
    }

    function clearFieldError(input) {
      if (!input) return;
      const next = input.nextElementSibling;
      if (next && next.classList.contains('input-error')) next.remove();
      input.classList.remove('border-red-400');
    }
    function showFieldError(input, msg) {
      if (!input) return;
      clearFieldError(input);
      const div = document.createElement('div');
      div.className = 'input-error';
      div.textContent = msg;
      input.classList.add('border-red-400');
      input.parentNode.insertBefore(div, input.nextSibling);
    }
    function clearAllErrors(form) {
      form.querySelectorAll('.input-error').forEach(el => el.remove());
      form.querySelectorAll('input, select, textarea').forEach(i => i.classList.remove('border-red-400'));
    }

    // ---------- NAVEGACIÓN POR PESTAÑAS ----------
    function switchTab(tabName) {
      if (tabName === 'casos') {
        casosView.classList.remove('hidden');
        vencimientosView.classList.add('hidden');
        tabCasos.classList.add('active');
        tabVencimientos.classList.remove('active');
      } else if (tabName === 'vencimientos') {
        casosView.classList.add('hidden');
        vencimientosView.classList.remove('hidden');
        tabCasos.classList.remove('active');
        tabVencimientos.classList.add('active');
      }
    }
    tabCasos.addEventListener('click', () => switchTab('casos'));
    tabVencimientos.addEventListener('click', () => switchTab('vencimientos'));

    // ---------- RENDERIZADO Y LÓGICA DE VISTAS ----------
    function updateCasesView() {
        let filteredCasos = [...casos];

        // 1. Filtrar
        if (searchQuery) {
            const lowerCaseQuery = searchQuery.toLowerCase();
            filteredCasos = filteredCasos.filter(c => {
                const caratula = `${c.actor} vs. ${c.demandado}`.toLowerCase();
                return c.expediente.toLowerCase().includes(lowerCaseQuery) ||
                       caratula.includes(lowerCaseQuery) ||
                       c.fuero.toLowerCase().includes(lowerCaseQuery) ||
                       c.juzgado.toLowerCase().includes(lowerCaseQuery);
            });
        }

        // 2. Ordenar
        filteredCasos.sort((a, b) => {
            let valA, valB;
            if (sortConfig.key === 'caratula') {
                valA = `${a.actor} vs. ${a.demandado}`.toLowerCase();
                valB = `${b.actor} vs. ${b.demandado}`.toLowerCase();
            } else {
                valA = a[sortConfig.key].toLowerCase();
                valB = b[sortConfig.key].toLowerCase();
            }

            if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
            if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
            return 0;
        });

        renderCases(filteredCasos);
        updateSortIcons();
    }

    function renderCases(casosToRender) {
      caseListBody.innerHTML = "";
      casosToRender.forEach(c => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700 hover-row";
        tr.dataset.id = c.id;
        tr.innerHTML = `
          <td class="px-6 py-4">${c.expediente}</td>
          <td class="px-6 py-4">${c.actor} vs. ${c.demandado}</td>
          <td class="px-6 py-4">${c.fuero}</td>
          <td class="px-6 py-4">${c.juzgado}</td>
          <td class="px-6 py-4 text-right">
            <div class="flex justify-end items-center space-x-2">
                <button class="view-btn bg-blue-600 hover:bg-blue-500 text-white text-xs px-2.5 py-1 rounded-md">Ver</button>
                <button class="edit-case-btn bg-gray-600 hover:bg-gray-500 text-white text-xs px-2.5 py-1 rounded-md">Editar</button>
                <button class="delete-case-btn bg-red-800 hover:bg-red-700 text-white text-xs px-2.5 py-1 rounded-md">Borrar</button>
            </div>
          </td>
        `;
        caseListBody.appendChild(tr);
      });
    }
    
    function updateSortIcons() {
        document.querySelectorAll('.sortable-header .sort-icon').forEach(icon => icon.textContent = '');
        const activeHeader = document.querySelector(`.sortable-header[data-sort="${sortConfig.key}"] .sort-icon`);
        if (activeHeader) {
            activeHeader.textContent = sortConfig.direction === 'ascending' ? '▲' : '▼';
        }
    }

    function renderMovements(caseId) {
      const lista = movimientos[caseId] || [];
      movementList.innerHTML = "";
      if (lista.length === 0) {
        movementList.innerHTML = "<p class='text-gray-400'>Sin movimientos registrados.</p>";
        return;
      }
      lista.forEach((m, index) => {
        const li = document.createElement("li");
        li.className = "bg-gray-700 p-4 rounded-lg shadow cursor-pointer";
        li.dataset.index = index;
        const filesCount = (m.archivos && m.archivos.length) ? m.archivos.length : 0;
        li.innerHTML = `
          <div class="flex justify-between items-center">
            <span class="font-semibold text-white">${m.fecha}</span>
            <div class="flex items-center gap-3">
              <span class="px-2 py-1 text-xs rounded ${m.tipo === "sentencia" ? "bg-red-600" : m.tipo === "decreto" ? "bg-blue-600" : "bg-green-600"}">
                ${m.tipo}
              </span>
              ${filesCount ? `<span class="text-xs text-gray-300">${filesCount} archivo(s)</span>` : ""}
            </div>
          </div>
          <p class="text-gray-300 mt-1">${m.descripcion}</p>
        `;
        movementList.appendChild(li);
      });
    }

    function renderVencimientos() {
        vencimientoListBody.innerHTML = "";
        vencimientos.forEach(v => {
            const casoVinculado = v.casoId ? casos.find(c => c.id === v.casoId) : null;
            const tr = document.createElement("tr");
            tr.className = "border-b border-gray-700 hover-row";
            tr.dataset.id = v.id;
            tr.innerHTML = `
                <td class="px-6 py-4">${v.titulo}</td>
                <td class="px-6 py-4">${casoVinculado ? `${casoVinculado.expediente} (${casoVinculado.actor} vs ${casoVinculado.demandado})` : "—"}</td>
                <td class="px-6 py-4">${v.fecha}</td>
                <td class="px-6 py-4">${v.recordatorio} días antes</td>
                <td class="px-6 py-4 text-right">
                    <div class="flex justify-end items-center space-x-2">
                        <button class="edit-vencimiento-btn bg-gray-600 hover:bg-gray-500 text-white text-xs px-2.5 py-1 rounded-md">Editar</button>
                        <button class="delete-vencimiento-btn bg-red-800 hover:bg-red-700 text-white text-xs px-2.5 py-1 rounded-md">Borrar</button>
                    </div>
                </td>
            `;
            vencimientoListBody.appendChild(tr);
        });
    }

    // ---------- LÓGICA DE CASOS (CRUD, BÚSQUEDA, ORDEN) ----------
    addCaseBtn.addEventListener("click", () => {
      caseMode = "create";
      caseForm.reset();
      document.getElementById('case-id').value = '';
      clearAllErrors(caseForm);
      caseModalTitle.textContent = "Agregar Nuevo Caso";
      document.getElementById("case-fuero-otro").classList.add("hidden");
      openModal(caseModal);
      setTimeout(() => document.getElementById("case-actor").focus(), 200);
    });
    xCaseBtn.addEventListener("click", () => closeModal(caseModal));
    cancelCaseBtn.addEventListener("click", () => closeModal(caseModal));

    document.getElementById("case-fuero").addEventListener("change", (e) => {
      const other = document.getElementById("case-fuero-otro");
      e.target.value === "Otro" ? other.classList.remove("hidden") : other.classList.add("hidden");
    });

    caseForm.addEventListener("submit", (e) => {
      e.preventDefault();
      clearAllErrors(caseForm);
      const id = document.getElementById('case-id').value;
      const expedienteInput = document.getElementById("case-expediente");
      const expediente = expedienteInput.value.trim();
      
      let hasError = false;
      if (!document.getElementById("case-actor").value.trim()) { showFieldError(document.getElementById("case-actor"), "Ingrese el actor."); hasError = true; }
      if (!document.getElementById("case-demandado").value.trim()) { showFieldError(document.getElementById("case-demandado"), "Ingrese el demandado."); hasError = true; }
      if (!expediente) { showFieldError(expedienteInput, "Ingrese el número de expediente."); hasError = true; }
      if (!document.getElementById("case-fuero").value) { showFieldError(document.getElementById("case-fuero"), "Seleccione un fuero."); hasError = true; }
      if (document.getElementById("case-fuero").value === "Otro" && !document.getElementById("case-fuero-otro").value.trim()) { showFieldError(document.getElementById("case-fuero-otro"), "Especifique el fuero."); hasError = true; }
      if (!document.getElementById("case-juzgado").value.trim()) { showFieldError(document.getElementById("case-juzgado"), "Ingrese el juzgado."); hasError = true; }

      if (expediente && casos.some(c => c.expediente.toLowerCase() === expediente.toLowerCase() && c.id !== Number(id))) {
        showFieldError(expedienteInput, "Ya existe un expediente con ese número.");
        hasError = true;
      }
      if (hasError) { showToast("Corrija los errores.", "warn"); return; }
      
      const fueroSel = document.getElementById("case-fuero").value;
      const fueroOtro = document.getElementById("case-fuero-otro").value.trim();
      const fuero = fueroSel === "Otro" ? fueroOtro : fueroSel;

      const casoData = {
        actor: document.getElementById("case-actor").value.trim(),
        demandado: document.getElementById("case-demandado").value.trim(),
        expediente,
        objeto: document.getElementById("case-objeto").value.trim(),
        fuero,
        juzgado: document.getElementById("case-juzgado").value.trim(),
        provincia: document.getElementById("case-provincia").value.trim(),
        abogado: document.getElementById("case-abogado").value.trim(),
        telefono: document.getElementById("case-telefono").value.trim(),
      };

      if (caseMode === 'edit') {
        const index = casos.findIndex(c => c.id === Number(id));
        if (index > -1) {
          casos[index] = { ...casos[index], ...casoData };
          showToast("Caso actualizado con éxito ✅", "success");
        }
      } else {
        const newId = casos.length ? Math.max(...casos.map(c => c.id)) + 1 : 1;
        casos.push({ id: newId, ...casoData });
        movimientos[newId] = [];
        showToast("Caso creado con éxito ✅", "success");
      }
      
      updateCasesView();
      renderVencimientos();
      closeModal(caseModal);
    });

    caseListBody.addEventListener("click", (e) => {
      const target = e.target;
      const caseId = Number(target.closest("tr").dataset.id);
      
      if (target.classList.contains("view-btn")) {
        const caso = casos.find(c => c.id === caseId);
        if (!caso) return;
        currentCaseId = caseId;
        detailsContent.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
            <div><strong>Actor:</strong><div class="mt-1">${caso.actor}</div></div>
            <div><strong>Demandado:</strong><div class="mt-1">${caso.demandado}</div></div>
            <div><strong>N° Expediente:</strong><div class="mt-1">${caso.expediente}</div></div>
            <div><strong>Objeto del juicio:</strong><div class="mt-1">${caso.objeto || "—"}</div></div>
            <div><strong>Fuero:</strong><div class="mt-1">${caso.fuero}</div></div>
            <div><strong>Juzgado:</strong><div class="mt-1">${caso.juzgado}</div></div>
            <div><strong>Provincia/Ciudad:</strong><div class="mt-1">${caso.provincia || "—"}</div></div>
            <div><strong>Abogado otra parte:</strong><div class="mt-1">${caso.abogado || "—"}</div></div>
            <div class="md:col-span-2"><strong>Teléfono del abogado:</strong><div class="mt-1">${caso.telefono || "—"}</div></div>
          </div>
        `;
        renderMovements(currentCaseId);
        openModal(detailsModal);
      } else if (target.classList.contains("edit-case-btn")) {
          const caso = casos.find(c => c.id === caseId);
          if (!caso) return;
          caseMode = 'edit';
          caseForm.reset();
          clearAllErrors(caseForm);
          caseModalTitle.textContent = "Editar Caso";

          document.getElementById('case-id').value = caso.id;
          document.getElementById('case-actor').value = caso.actor;
          document.getElementById('case-demandado').value = caso.demandado;
          document.getElementById('case-expediente').value = caso.expediente;
          document.getElementById('case-objeto').value = caso.objeto;
          document.getElementById('case-fuero').value = caso.fuero;
          document.getElementById('case-juzgado').value = caso.juzgado;
          document.getElementById('case-provincia').value = caso.provincia;
          document.getElementById('case-abogado').value = caso.abogado;
          document.getElementById('case-telefono').value = caso.telefono;
          
          openModal(caseModal);
      } else if (target.classList.contains("delete-case-btn")) {
          if (confirm('¿Está seguro de que desea eliminar este caso? Esta acción no se puede deshacer.')) {
              casos = casos.filter(c => c.id !== caseId);
              delete movimientos[caseId];
              vencimientos.forEach(v => {
                  if (v.casoId === caseId) v.casoId = null;
              });
              updateCasesView();
              renderVencimientos();
              showToast('Caso eliminado 🗑️', 'success');
          }
      }
    });
    closeDetailsBtn.addEventListener("click", () => closeModal(detailsModal));
    
    searchCasosInput.addEventListener('input', (e) => {
        searchQuery = e.target.value;
        updateCasesView();
    });

    casosThead.addEventListener('click', (e) => {
        const header = e.target.closest('.sortable-header');
        if (!header) return;
        
        const sortKey = header.dataset.sort;
        if (sortConfig.key === sortKey) {
            sortConfig.direction = sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
        } else {
            sortConfig.key = sortKey;
            sortConfig.direction = 'ascending';
        }
        updateCasesView();
    });

    // ---------- LÓGICA DE MOVIMIENTOS ----------
    addMovementBtn.addEventListener("click", () => {
      movementMode = "create";
      movementForm.reset();
      clearAllErrors(movementForm);
      keptFiles = [];
      newFiles = [];
      renderFilePreview();
      movementModalTitle.textContent = "Agregar Movimiento";
      openModal(movementModal);
      setTimeout(() => document.getElementById("mov-fecha").focus(), 200);
    });
    xMovementBtn.addEventListener("click", () => closeModal(movementModal));
    cancelMovementBtn.addEventListener("click", () => closeModal(movementModal));

    movArchivosInput.addEventListener("change", (e) => {
      Array.from(e.target.files || []).forEach(f => {
        const id = 'nf_' + Date.now().toString(36) + Math.random().toString(36).slice(2);
        newFiles.push({ id, nombre: f.name, url: URL.createObjectURL(f), file: f });
      });
      renderFilePreview();
      movArchivosInput.value = "";
    });

    function renderFilePreview() {
      filePreview.innerHTML = "";
      [...keptFiles, ...newFiles].forEach((f, idx) => {
        const isKept = idx < keptFiles.length;
        const div = document.createElement('div');
        div.className = 'file-pill';
        div.innerHTML = `<a href="${f.url}" target="_blank" class="file-link">${f.nombre}</a> <button data-idx="${idx}">✖</button>`;
        div.querySelector('button').addEventListener('click', () => {
          if (isKept) {
            if (confirm('¿Quitar este archivo guardado del movimiento?')) keptFiles.splice(idx, 1);
          } else {
            newFiles.splice(idx - keptFiles.length, 1);
          }
          renderFilePreview();
        });
        filePreview.appendChild(div);
      });
      if (keptFiles.length === 0 && newFiles.length === 0) {
        filePreview.innerHTML = "<p class='text-gray-400 text-sm'>No hay archivos seleccionados.</p>";
      }
    }

    movementForm.addEventListener("submit", (e) => {
      e.preventDefault();
      clearAllErrors(movementForm);
      let hasErr = false;
      if (!document.getElementById("mov-fecha").value) { showFieldError(document.getElementById("mov-fecha"), "Ingrese la fecha."); hasErr = true; }
      if (!document.getElementById("mov-tipo").value) { showFieldError(document.getElementById("mov-tipo"), "Seleccione el tipo."); hasErr = true; }
      if (!document.getElementById("mov-descripcion").value.trim()) { showFieldError(document.getElementById("mov-descripcion"), "Ingrese una descripción."); hasErr = true; }
      if (hasErr) { showToast("Corrija los errores.", "warn"); return; }
      
      const archivosFinal = [...keptFiles, ...newFiles.map(nf => ({ id: nf.id, nombre: nf.nombre, url: nf.url }))];
      const entry = {
        fecha: document.getElementById("mov-fecha").value,
        tipo: document.getElementById("mov-tipo").value,
        descripcion: document.getElementById("mov-descripcion").value.trim(),
        detalle: document.getElementById("mov-detalle").value.trim(),
        archivos: archivosFinal,
      };

      if (movementMode === "edit" && currentMovementIndex !== null) {
        movimientos[currentCaseId][currentMovementIndex] = entry;
        showToast("Movimiento actualizado ✅", "success");
      } else {
        movimientos[currentCaseId].push(entry);
        showToast("Movimiento agregado ✅", "success");
      }
      renderMovements(currentCaseId);
      closeModal(movementModal);
    });

    movementList.addEventListener("click", (e) => {
      const li = e.target.closest("li");
      if (!li) return;
      currentMovementIndex = Number(li.dataset.index);
      const mov = (movimientos[currentCaseId] || [])[currentMovementIndex];
      if (!mov) return;

      let fileBlock = "";
      if (mov.archivos && mov.archivos.length) {
        fileBlock = `<div><strong>Archivos:</strong><div class="mt-2 space-y-2">${mov.archivos.map(f => `<div class="flex items-center justify-between bg-gray-700 p-2 rounded"><a href="${f.url}" target="_blank" class="file-link">${f.nombre}</a></div>`).join('')}</div></div>`;
      }
      movementDetailContent.innerHTML = `
        <p><strong>Fecha:</strong> ${mov.fecha}</p>
        <p><strong>Tipo:</strong> ${mov.tipo}</p>
        <p><strong>Descripción:</strong> ${mov.descripcion}</p>
        <div><p class="mb-1"><strong>Detalle:</strong></p><div class="whitespace-pre-wrap bg-gray-700 p-3 rounded">${mov.detalle || "—"}</div></div>
        ${fileBlock}
      `;
      openModal(movementDetailModal);
    });
    closeMovementDetailBtn.addEventListener("click", () => closeModal(movementDetailModal));

    editMovementBtn.addEventListener("click", () => {
      const mov = (movimientos[currentCaseId] || [])[currentMovementIndex];
      if (!mov) return;
      document.getElementById("mov-fecha").value = mov.fecha || "";
      document.getElementById("mov-tipo").value = mov.tipo || "";
      document.getElementById("mov-descripcion").value = mov.descripcion || "";
      document.getElementById("mov-detalle").value = mov.detalle || "";
      keptFiles = mov.archivos ? mov.archivos.map(f => ({...f})) : [];
      newFiles = [];
      renderFilePreview();
      movementMode = "edit";
      movementModalTitle.textContent = "Editar Movimiento";
      closeModal(movementDetailModal);
      openModal(movementModal);
    });

    deleteMovementBtn.addEventListener("click", () => {
      if (confirm("¿Eliminar este movimiento?")) {
        movimientos[currentCaseId].splice(currentMovementIndex, 1);
        renderMovements(currentCaseId);
        closeModal(movementDetailModal);
        showToast("Movimiento eliminado 🗑️", "success");
      }
    });

    // ---------- LÓGICA DE VENCIMIENTOS ----------
    function populateCasosSelect(selectedId = null) {
        vencimientoCasoIdSelect.innerHTML = '<option value="">Ninguno</option>';
        casos.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = `${c.expediente} (${c.actor} vs ${c.demandado})`;
            if (selectedId && c.id === selectedId) {
                option.selected = true;
            }
            vencimientoCasoIdSelect.appendChild(option);
        });
    }

    addVencimientoBtn.addEventListener("click", () => {
        vencimientoMode = "create";
        vencimientoForm.reset();
        document.getElementById('vencimiento-id').value = '';
        clearAllErrors(vencimientoForm);
        vencimientoModalTitle.textContent = "Agregar Vencimiento";
        populateCasosSelect();
        openModal(vencimientoModal);
        setTimeout(() => document.getElementById("vencimiento-titulo").focus(), 200);
    });

    xVencimientoBtn.addEventListener("click", () => closeModal(vencimientoModal));
    cancelVencimientoBtn.addEventListener("click", () => closeModal(vencimientoModal));

    vencimientoForm.addEventListener("submit", (e) => {
        e.preventDefault();
        clearAllErrors(vencimientoForm);
        let hasError = false;
        if (!document.getElementById("vencimiento-titulo").value.trim()) { showFieldError(document.getElementById("vencimiento-titulo"), "Ingrese un título."); hasError = true; }
        if (!document.getElementById("vencimiento-fecha").value) { showFieldError(document.getElementById("vencimiento-fecha"), "Ingrese una fecha."); hasError = true; }
        if (!document.getElementById("vencimiento-recordatorio").value) { showFieldError(document.getElementById("vencimiento-recordatorio"), "Seleccione un recordatorio."); hasError = true; }
        if (hasError) { showToast("Corrija los errores.", "warn"); return; }
        
        const id = document.getElementById('vencimiento-id').value;
        const vencimientoData = {
            titulo: document.getElementById("vencimiento-titulo").value.trim(),
            fecha: document.getElementById("vencimiento-fecha").value,
            casoId: document.getElementById("vencimiento-caso-id").value ? Number(document.getElementById("vencimiento-caso-id").value) : null,
            recordatorio: Number(document.getElementById("vencimiento-recordatorio").value),
        };

        if (vencimientoMode === 'edit') {
            const index = vencimientos.findIndex(v => v.id === Number(id));
            if (index > -1) {
                vencimientos[index] = { id: Number(id), ...vencimientoData };
                showToast("Vencimiento actualizado ✅", "success");
            }
        } else {
            const newId = vencimientos.length ? Math.max(...vencimientos.map(v => v.id)) + 1 : 1;
            vencimientos.push({ id: newId, ...vencimientoData });
            showToast("Vencimiento agregado ✅", "success");
        }
        renderVencimientos();
        closeModal(vencimientoModal);
    });

    vencimientoListBody.addEventListener('click', (e) => {
        const target = e.target;
        const id = Number(target.closest('tr').dataset.id);

        if (target.classList.contains('edit-vencimiento-btn')) {
            const vencimiento = vencimientos.find(v => v.id === id);
            if (!vencimiento) return;
            vencimientoMode = 'edit';
            vencimientoForm.reset();
            clearAllErrors(vencimientoForm);
            vencimientoModalTitle.textContent = "Editar Vencimiento";

            document.getElementById('vencimiento-id').value = vencimiento.id;
            document.getElementById('vencimiento-titulo').value = vencimiento.titulo;
            document.getElementById('vencimiento-fecha').value = vencimiento.fecha;
            document.getElementById('vencimiento-recordatorio').value = vencimiento.recordatorio;
            populateCasosSelect(vencimiento.casoId);
            openModal(vencimientoModal);
        }

        if (target.classList.contains('delete-vencimiento-btn')) {
            if (confirm('¿Está seguro de que desea eliminar este vencimiento?')) {
                vencimientos = vencimientos.filter(v => v.id !== id);
                renderVencimientos();
                showToast('Vencimiento eliminado 🗑️', 'success');
            }
        }
    });

    // ---------- SISTEMA DE RECORDATORIOS ----------
    function checkForUpcomingDeadlines() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        vencimientos.forEach(v => {
            const fechaVencimiento = new Date(v.fecha + 'T00:00:00');
            const diffTime = fechaVencimiento.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays >= 0 && diffDays <= v.recordatorio) {
                const caso = v.casoId ? casos.find(c => c.id === v.casoId) : null;
                const casoInfo = caso ? ` (${caso.expediente})` : '';
                const msg = `⚠️ Vencimiento próximo: ${v.titulo}${casoInfo} en ${diffDays} día(s).`;
                showToast(msg, 'warn', 5000);
            }
        });
    }

    // ---------- INICIALIZACIÓN ----------
    function initialize() {
        updateCasesView();
        renderVencimientos();
        checkForUpcomingDeadlines();
    }
    
    initialize();

  </script>
</body>
</html>
