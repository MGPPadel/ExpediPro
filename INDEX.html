<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AbogApp</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f9;
    }
    /* LOGIN */
    #login {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #login-box {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 300px;
      text-align: center;
    }
    #login-box input {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    #login-box button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
    }
    #logout {
      float: right;
      margin: 10px;
      cursor: pointer;
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <section id="login">
    <div id="login-box">
      <h2>Iniciar Sesi√≥n</h2>
      <input type="email" id="email" placeholder="Correo">
      <input type="password" id="password" placeholder="Contrase√±a">
      <button onclick="login()">Ingresar</button>
    </div>
  </section>

  <!-- TU APP COMPLETA -->
  <section id="app" style="display:none;">
    <span id="logout" onclick="logout()">üîí Cerrar Sesi√≥n</span>
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>‚öñÔ∏è Estudio Jur√≠dico</h1>
      <span class="pill">MVP local <span class="muted-text">(datos guardados en tu navegador)</span></span>
      <div class="right flex gap-2">
        <input id="user" placeholder="Usuario" style="width:110px" />
        <input id="pass" type="password" placeholder="Clave" style="width:110px" />
        <button class="btn" id="btnLogin">Login</button>
        <span id="loginStatus" class="pill">Offline</span>
        <button class="btn" id="btnLoadBackend">Cargar backend</button>
        <button class="btn" id="btnExport">Exportar JSON</button>
        <label class="btn ghost" for="importFile">Importar JSON</label>
        <input type="file" id="importFile" accept="application/json" class="hidden" />
      </div>
    </header>

    <div class="container">
      <aside>
        <div class="card">
          <div class="toolbar">
            <button class="btn primary" data-nav="juicios">Juicios</button>
            <button class="btn" data-nav="agenda">Agenda / Vencimientos</button>
            <button class="btn" data-nav="plantillas">Escritos</button>
            <button class="btn" data-nav="config">Configuraci√≥n</button>
          </div>
          <div class="notice">
            <strong>Privacidad:</strong> este MVP funciona 100% en tu equipo y guarda los datos en <em>localStorage</em>. Para uso real en equipo, hay que migrar a servidor seguro con cifrado y usuarios.
          </div>
        </div>

        <div class="card">
          <h3>Buscar / Filtrar</h3>
          <div class="grid">
            <input id="search" placeholder="Buscar por cliente, n¬∞ expediente, juzgado..." />
            <div class="grid cols-2">
              <select id="filtroFuero">
                <option value="">Fuero (todos)</option>
                <option>Laboral</option>
                <option>Civil</option>
                <option>Familia</option>
                <option>Penal</option>
                <option>Comercial</option>
              </select>
              <select id="filtroCiudad">
                <option value="">Ciudad (todas)</option>
                <option>San Miguel</option>
                <option>Concepci√≥n</option>
                <option>Monteros</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Nuevo Juicio</h3>
          <form id="formJuicio" class="grid">
            <div class="grid cols-2">
              <div>
                <label>Actor</label>
                <input name="actor" required />
              </div>
              <div>
                <label>Demandado</label>
                <input name="demandado" required />
              </div>
            </div>
            <div class="grid cols-2">
              <div>
                <label>N¬∞ de expediente</label>
                <input name="expediente" required />
              </div>
              <div>
                <label>Objeto del juicio</label>
                <input name="objeto" />
              </div>
            </div>
            <div class="grid cols-3">
              <div>
                <label>Fuero</label>
                <select name="fuero">
                  <option>Laboral</option>
                  <option>Civil</option>
                  <option>Familia</option>
                  <option>Penal</option>
                  <option>Comercial</option>
                </select>
              </div>
              <div>
                <label>Juzgado</label>
                <input name="juzgado" />
              </div>
              <div>
                <label>Ciudad</label>
                <select name="ciudad">
                  <option>San Miguel</option>
                  <option>Concepci√≥n</option>
                  <option>Monteros</option>
                </select>
              </div>
            </div>
            <div>
              <label>Abogado de la otra parte</label>
              <input name="abogadoContrario" />
            </div>
            <button class="btn primary" type="submit">‚ûï Crear juicio</button>
          </form>
        </div>
      </aside>

      <main>
        <!-- Juicios / detalle -->
        <section id="sec-juicios" class="section active">
          <div class="toolbar">
            <span class="muted-text">Lista de expedientes</span>
            <span class="right muted-text" id="resumenJuicios"></span>
          </div>
          <div id="listJuicios" class="list"></div>
          <div id="emptyJuicios" class="empty hidden">No hay juicios cargados todav√≠a.</div>

          <hr style="border:0;border-top:1px solid var(--muted-2);margin:14px 0" />

          <div id="detalleJuicio" class="hidden">
            <h2 id="dj-titulo">Expediente</h2>
            <div class="grid cols-4">
              <div class="card"><div class="muted-text">Actor</div><div id="dj-actor"></div></div>
              <div class="card"><div class="muted-text">Demandado</div><div id="dj-demandado"></div></div>
              <div class="card"><div class="muted-text">N¬∞ Expediente</div><div id="dj-exp"></div></div>
              <div class="card"><div class="muted-text">Fuero</div><div id="dj-fuero"></div></div>
              <div class="card"><div class="muted-text">Juzgado</div><div id="dj-juzgado"></div></div>
              <div class="card"><div class="muted-text">Ciudad</div><div id="dj-ciudad"></div></div>
              <div class="card"><div class="muted-text">Abog. contrario</div><div id="dj-contrario"></div></div>
              <div class="card"><div class="muted-text">Vencimientos</div><div id="dj-vencTotal"></div></div>
            </div>

            <div class="grid cols-2" style="margin-top:10px">
              <div class="card">
                <div class="flex gap-2"><h3 class="grow">Movimientos</h3><button class="btn" id="btnAddMov">‚ûï Nuevo</button></div>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Tipo</th>
                      <th>Descripci√≥n</th>
                      <th>Adjunto</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="tablaMov"></tbody>
                </table>
                <div id="emptyMov" class="empty hidden">Sin movimientos a√∫n.</div>
              </div>

              <div class="card">
                <div class="flex gap-2"><h3 class="grow">Vencimientos / Audiencias</h3><button class="btn" id="btnAddVto">‚ûï Nuevo</button></div>
                <table class="table">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Detalle</th>
                      <th>Anticipo</th>
                      <th>Estado</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="tablaVto"></tbody>
                </table>
                <div id="emptyVto" class="empty hidden">Sin vencimientos.</div>
              </div>
            </div>

            <div class="card">
              <div class="flex gap-2"><h3 class="grow">Cuadernos de Prueba</h3><button class="btn" id="btnAddCuaderno">‚ûï Nuevo</button></div>
              <div id="listaCuadernos" class="list"></div>
              <div id="emptyCua" class="empty hidden">A√∫n no hay cuadernos (Testimonial, Pericial, Informes...).</div>
            </div>
          </div>
        </section>

        <!-- Agenda global -->
        <section id="sec-agenda" class="section">
          <div class="toolbar">
            <h2 class="grow">Agenda y alertas</h2>
            <div class="flex gap-2">
              <label class="muted-text">Mostrar pr√≥ximos d√≠as</label>
              <input type="number" id="agendaDias" value="30" min="1" style="width:90px" />
              <button class="btn" id="btnRefrescarAgenda">Actualizar</button>
            </div>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Expediente</th>
                <th>Detalle</th>
                <th>Anticipo</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="agendaBody"></tbody>
          </table>
          <div id="agendaVacia" class="empty hidden">No hay eventos en el rango.</div>
        </section>

        <!-- Escritos (plantillas simples) -->
        <section id="sec-plantillas" class="section">
          <div class="grid cols-2">
            <div class="card">
              <h3>Redactor r√°pido</h3>
              <div class="grid">
                <label>T√≠tulo</label>
                <input id="escTitulo" placeholder="Escrito / Presentaci√≥n..." />
                <label>Contenido</label>
                <textarea id="escContenido" rows="10" placeholder="Escrib√≠ ac√° y luego export√° .docx o asoci√° al movimiento"></textarea>
                <div class="flex gap-2">
                  <button class="btn" id="btnAdjuntarEscrito">Asociar al √∫ltimo movimiento del expediente abierto</button>
                  <button class="btn" id="btnExportDoc">Exportar .txt</button>
                </div>
                <div class="notice">En el MVP exportamos a <span class="kbd">.txt</span> para simplicidad. En producci√≥n se genera <span class="kbd">.docx</span> listo para firma digital.</div>
              </div>
            </div>
            <div class="card">
              <h3>Plantillas</h3>
              <div class="list" id="listaPlantillas"></div>
              <div class="empty">Sumaremos editor de plantillas en pr√≥ximas iteraciones.</div>
            </div>
          </div>
        </section>

        <!-- Configuraci√≥n -->
        <section id="sec-config" class="section">
          <div class="grid cols-2">
            <div class="card">
              <h3>Preferencias de recordatorio</h3>
              <div class="grid cols-3">
                <div>
                  <label>Anticipo r√°pido 1</label>
                  <input id="prefA1" type="number" value="1" min="0" />
                </div>
                <div>
                  <label>Anticipo r√°pido 2</label>
                  <input id="prefA2" type="number" value="5" min="0" />
                </div>
                <div>
                  <label>Anticipo r√°pido 3</label>
                  <input id="prefA3" type="number" value="10" min="0" />
                </div>
              </div>
              <div class="notice">Estos valores aparecen como atajos al crear vencimientos.</div>
            </div>
            <div class="card">
              <h3>Datos y seguridad</h3>
              <div class="grid">
                <button class="btn" id="btnBackup">Descargar backup JSON</button>
                <button class="btn danger" id="btnBorrarTodo">Borrar todo (local)</button>
                <div class="notice danger-text">Este MVP guarda datos solo en tu navegador. Para uso colaborativo real: servidor con cifrado, usuarios/roles, backups autom√°ticos y auditor√≠a.</div>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- Modales simples -->
  <dialog id="dlgMov" class="card" style="max-width:700px">
    <form method="dialog" id="formMov" class="grid">
      <h3>Nuevo movimiento</h3>
      <div class="grid cols-3">
        <div>
          <label>Fecha</label>
          <input type="date" name="fecha" required />
        </div>
        <div>
          <label>Tipo</label>
          <select name="tipo">
            <option>Escrito</option>
            <option>Decreto</option>
            <option>Sentencia</option>
            <option>Otro</option>
          </select>
        </div>
        <div>
          <label>Descripci√≥n breve</label>
          <input name="resumen" placeholder="p.ej. Se abre a prueba por 15 d√≠as" />
        </div>
      </div>
      <div>
        <label>Texto completo</label>
        <textarea name="texto" rows="6" placeholder="Peg√° aqu√≠ el decreto completo o el texto del escrito"></textarea>
      </div>
      <div>
        <label>Adjuntar PDF (opcional)</label>
        <input type="file" name="pdf" accept="application/pdf" />
      </div>
      <div class="flex gap-2 right">
        <button class="btn ghost" value="cancel">Cancelar</button>
        <button class="btn primary" value="ok">Guardar</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlgVto" class="card" style="max-width:600px">
    <form method="dialog" id="formVto" class="grid">
      <h3>Nuevo vencimiento / audiencia</h3>
      <div class="grid cols-2">
        <div>
          <label>Fecha</label>
          <input type="date" name="fecha" required />
        </div>
        <div>
          <label>Detalle</label>
          <input name="detalle" placeholder="Audiencia testimonial, contestaci√≥n, etc." />
        </div>
      </div>
      <div class="grid cols-3">
        <div>
          <label>Anticipar (d√≠as)</label>
          <input type="number" name="anticipar" value="5" min="0" />
        </div>
        <div>
          <label>Atajos</label>
          <div class="flex">
            <button class="btn" type="button" data-atajo="prefA1"></button>
            <button class="btn" type="button" data-atajo="prefA2"></button>
            <button class="btn" type="button" data-atajo="prefA3"></button>
          </div>
        </div>
        <div>
          <label>Estado</label>
          <select name="estado">
            <option>Pendiente</option>
            <option>Hecho</option>
            <option>Reprogramado</option>
          </select>
        </div>
      </div>
      <div class="flex gap-2 right">
        <button class="btn ghost" value="cancel">Cancelar</button>
        <button class="btn primary" value="ok">Guardar</button>
      </div>
    </form>
  </dialog>

  <dialog id="dlgCuaderno" class="card" style="max-width:520px">
    <form method="dialog" id="formCuaderno" class="grid">
      <h3>Nuevo cuaderno de prueba</h3>
      <div class="grid cols-2">
        <div>
          <label>Tipo</label>
          <select name="tipo">
            <option>Testimonial</option>
            <option>Pericial</option>
            <option>Informes</option>
            <option>Otro</option>
          </select>
        </div>
        <div>
          <label>Nombre / Identificador</label>
          <input name="nombre" placeholder="Ej. Testigos A-B" />
        </div>
      </div>
      <div>
        <label>Notas</label>
        <textarea name="notas" rows="4"></textarea>
      </div>
      <div class="flex gap-2 right">
        <button class="btn ghost" value="cancel">Cancelar</button>
        <button class="btn primary" value="ok">Crear</button>
      </div>
    </form>
  </dialog>

  <script>
    /* =================== Estado y utilidades =================== */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const DB_KEY = 'legal-mvp-db-v1';
    const state = {
      juicios: [], // {id, actor, demandado, expediente, objeto, fuero, juzgado, ciudad, abogadoContrario, movs:[], vtos:[], cuadernos:[]}
      prefs: { a1:1, a2:5, a3:10 }
    };
    const fmtDate = (d) => new Date(d).toLocaleDateString('es-AR');
    const todayISO = () => new Date().toISOString().slice(0,10);
    const uid = () => Math.random().toString(36).slice(2,9);

    function save(){ localStorage.setItem(DB_KEY, JSON.stringify(state)); render(); }
    function load(){
      const raw = localStorage.getItem(DB_KEY);
      if(raw){ try{ const obj = JSON.parse(raw); Object.assign(state, obj); }catch(e){ console.error(e); }}
    }

    /* =================== Conexi√≥n con Backend =================== */
const API_BASE = 'http://localhost:3000';
let token = localStorage.getItem('jwt') || null;

function setAuthUI(){
  const el = $('#loginStatus');
  if(!el) return;
  const online = !!token;
  el.textContent = online ? 'Conectado' : 'Offline';
  el.className = 'pill ' + (online ? 'ok-text' : 'muted-text');
}
setAuthUI();

async function loginBackend(){
  const username = $('#user').value;
  const password = $('#pass').value;
  try{
    const res = await fetch(API_BASE + '/login',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({username,password})
    });
    if(!res.ok) throw new Error('Login');
    const data = await res.json();
    token = data.token; localStorage.setItem('jwt', token);
    setAuthUI();
    alert('‚úÖ Login OK');
  }catch(e){
    token = null; localStorage.removeItem('jwt'); setAuthUI();
    alert('‚ùå Login incorrecto');
  }
}

async function cargarDesdeBackend(){
  if(!token){ alert('Primero inici√° sesi√≥n'); return; }
  try{
    const res = await fetch(API_BASE + '/juicios', { headers:{ Authorization:'Bearer '+token } });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const juicios = await res.json();
    state.juicios = (juicios||[]).map(j=>({
      id: String(j.id || uid()),
      actor: j.actor||'', demandado: j.demandado||'', expediente: j.expediente||'', objeto: j.objeto||'',
      fuero: j.fuero||'Laboral', juzgado: j.juzgado||'', ciudad: j.ciudad||'', abogadoContrario: j.abogadoContrario||'',
      movs: j.movs||[], vtos: j.vtos||[], cuadernos: j.cuadernos||[]
    }));
    save(); render();
    alert('üì• Juicios cargados desde backend');
  }catch(err){ alert('Error al cargar: '+err.message); }
}

$('#btnLogin')?.addEventListener('click', loginBackend);
$('#btnLoadBackend')?.addEventListener('click', cargarDesdeBackend);

/* =================== Navegaci√≥n =================== */
    $$("[data-nav]").forEach(btn=>{
      btn.addEventListener('click',()=>{
        const target = btn.getAttribute('data-nav');
        $$('.section').forEach(s=>s.classList.remove('active'));
        $('#sec-'+target).classList.add('active');
      });
    });

    /* =================== Filtros / b√∫squeda =================== */
    ['search','filtroFuero','filtroCiudad'].forEach(id=>{
      $('#'+id).addEventListener('input', ()=> renderJuicios());
    });

    /* =================== Crear juicio =================== */
    $('#formJuicio').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const j = Object.fromEntries(fd.entries());
      const ju = { id: uid(), ...j, movs:[], vtos:[], cuadernos:[] };

      // Si hay login, intentamos guardar tambi√©n en el backend
      if(token){
        try{
          const res = await fetch(API_BASE + '/juicios',{
            method:'POST',
            headers:{'Content-Type':'application/json', Authorization:'Bearer '+token},
            body: JSON.stringify(ju)
          });
          if(res.ok){ const saved = await res.json(); ju.id = String(saved.id || ju.id); }
        }catch(err){ console.warn('No se pudo guardar en backend:', err.message); }
      }

      state.juicios.unshift(ju);
      e.target.reset();
      save();
      selectJuicio(ju.id);
    });

    /* =================== Render juicios =================== */
    function renderJuicios(){
      const cont = $('#listJuicios');
      cont.innerHTML = '';
      const q = $('#search').value.toLowerCase().trim();
      const fuero = $('#filtroFuero').value;
      const ciudad = $('#filtroCiudad').value;

      const lista = state.juicios.filter(j=>{
        const matchQ = !q || [j.actor,j.demandado,j.expediente,j.juzgado,j.objeto].some(v=>String(v||'').toLowerCase().includes(q));
        const matchF = !fuero || j.fuero===fuero;
        const matchC = !ciudad || j.ciudad===ciudad;
        return matchQ && matchF && matchC;
      });

      $('#resumenJuicios').textContent = `${lista.length} juicios (total ${state.juicios.length})`;
      $('#emptyJuicios').classList.toggle('hidden', lista.length>0);

      lista.forEach(j=>{
        const vtosPend = j.vtos.filter(v=>v.estado!=='Hecho').length;
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div class="meta">
            <strong>${j.actor}</strong> vs <strong>${j.demandado}</strong>
            <span class="tag">Exp: ${j.expediente||'-'}</span>
            <span class="tag">${j.fuero}</span>
            <span class="tag">${j.ciudad}</span>
            ${vtosPend?`<span class="tag" style="border-color:var(--warn);color:#fde68a">${vtosPend} pendientes</span>`:''}
          </div>
          <div class="meta">
            <button class="btn" data-open="${j.id}">Abrir</button>
            <button class="btn danger" data-del="${j.id}">Eliminar</button>
          </div>
        `;
        cont.appendChild(row);
      });

      $$('[data-open]').forEach(b=> b.onclick = ()=> selectJuicio(b.getAttribute('data-open')));
      $$('[data-del]').forEach(b=> b.onclick = ()=> delJuicio(b.getAttribute('data-del')));
    }

    function delJuicio(id){
      if(!confirm('¬øEliminar juicio y todos sus datos?')) return;
      const ix = state.juicios.findIndex(x=>x.id===id);
      if(ix>=0){ state.juicios.splice(ix,1); save(); $('#detalleJuicio').classList.add('hidden'); }
    }

    /* =================== Detalle de juicio =================== */
    let currentId = null;
    function selectJuicio(id){
      currentId = id;
      const j = state.juicios.find(x=>x.id===id);
      if(!j) return;
      $('#sec-juicios').classList.add('active');
      $$('.section').forEach(s=>{ if(s.id!=='sec-juicios') s.classList.remove('active'); });
      $('#detalleJuicio').classList.remove('hidden');
      $('#dj-titulo').textContent = `${j.actor} vs ${j.demandado}`;
      $('#dj-actor').textContent = j.actor;
      $('#dj-demandado').textContent = j.demandado;
      $('#dj-exp').textContent = j.expediente||'-';
      $('#dj-fuero').textContent = j.fuero;
      $('#dj-juzgado').textContent = j.juzgado||'-';
      $('#dj-ciudad').textContent = j.ciudad||'-';
      $('#dj-contrario').textContent = j.abogadoContrario||'-';
      $('#dj-vencTotal').textContent = `${j.vtos.filter(v=>v.estado!=='Hecho').length} pendientes`;
      renderMov(j); renderVto(j); renderCuadernos(j);
    }

    /* =================== Movimientos =================== */
    $('#btnAddMov').onclick = ()=>{
      if(!currentId) return alert('Primero abr√≠ un expediente.');
      $('#formMov').reset();
      $('#formMov [name=fecha]').value = todayISO();
      $('#dlgMov').showModal();
    };

    $('#dlgMov').addEventListener('close', ()=>{
      if($('#dlgMov').returnValue!=="ok") return;
      const j = state.juicios.find(x=>x.id===currentId);
      const fd = new FormData($('#formMov'));
      const mov = Object.fromEntries(fd.entries());
      mov.id = uid();
      if(fd.get('pdf') && fd.get('pdf').size>0){ mov.pdfName = fd.get('pdf').name; mov.pdfUrl = URL.createObjectURL(fd.get('pdf')); }
      j.movs.unshift(mov);
      save();
      setTimeout(()=> $('#dlgMov').close(), 0);
    });

    function renderMov(j){
      const body = $('#tablaMov'); body.innerHTML='';
      $('#emptyMov').classList.toggle('hidden', j.movs.length>0);
      j.movs.forEach(m=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.fecha?fmtDate(m.fecha):'-'}</td>
          <td><span class="tag type-${m.tipo||'Otro'}">${m.tipo||'Otro'}</span></td>
          <td>${m.resumen||''}<div class="muted-text">${(m.texto||'').slice(0,90)}</div></td>
          <td>${m.pdfUrl?`<a class="btn" href="${m.pdfUrl}" target="_blank">Ver PDF</a>`:'-'}</td>
          <td><button class="btn danger" data-delmov="${m.id}">Eliminar</button></td>
        `;
        body.appendChild(tr);
      });
      $$('[data-delmov]').forEach(b=> b.onclick=()=>{
        if(!confirm('¬øEliminar movimiento?')) return;
        const ix = j.movs.findIndex(x=>x.id===b.getAttribute('data-delmov'));
        if(ix>=0){ j.movs.splice(ix,1); save(); }
      });
    }

    /* =================== Vencimientos =================== */
    function refreshAtajos(){
      const {a1,a2,a3} = state.prefs;
      $$('[data-atajo]').forEach(btn=>{
        const key = btn.getAttribute('data-atajo');
        const val = state.prefs[key.replace('pref','a')] || 0;
        btn.textContent = val+" d";
        btn.onclick = ()=> { $('#formVto [name=anticipar]').value = val; };
      });
      $('#prefA1').value = a1; $('#prefA2').value = a2; $('#prefA3').value = a3;
    }

    $('#prefA1').oninput = e=>{ state.prefs.a1 = Number(e.target.value||0); save(); refreshAtajos(); };
    $('#prefA2').oninput = e=>{ state.prefs.a2 = Number(e.target.value||0); save(); refreshAtajos(); };
    $('#prefA3').oninput = e=>{ state.prefs.a3 = Number(e.target.value||0); save(); refreshAtajos(); };

    $('#btnAddVto').onclick = ()=>{
      if(!currentId) return alert('Primero abr√≠ un expediente.');
      $('#formVto').reset();
      $('#formVto [name=fecha]').value = todayISO();
      refreshAtajos();
      $('#dlgVto').showModal();
    };

    $('#dlgVto').addEventListener('close', ()=>{
      if($('#dlgVto').returnValue!=="ok") return;
      const j = state.juicios.find(x=>x.id===currentId);
      const fd = new FormData($('#formVto'));
      const v = Object.fromEntries(fd.entries());
      v.id = uid(); v.anticipar = Number(v.anticipar||0);
      j.vtos.unshift(v);
      save();
      setTimeout(()=> $('#dlgVto').close(), 0);
    });

    function renderVto(j){
      const body = $('#tablaVto'); body.innerHTML='';
      $('#emptyVto').classList.toggle('hidden', j.vtos.length>0);
      j.vtos.forEach(v=>{
        const dias = diasRestantes(v.fecha);
        const estadoColor = v.estado==='Hecho' ? 'ok-text' : (dias<0 ? 'danger-text' : (dias<=v.anticipar ? 'warn-text' : ''));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(v.fecha)}</td>
          <td>${v.detalle||'-'}</td>
          <td>${v.anticipar||0} d</td>
          <td class="${estadoColor}">${v.estado}${v.estado!=='Hecho' ? ` (${dias} d√≠as)` : ''}</td>
          <td><button class="btn" data-vto-done="${v.id}">Marcar hecho</button> <button class="btn danger" data-vto-del="${v.id}">Eliminar</button></td>
        `;
        body.appendChild(tr);
      });
      $$('[data-vto-done]').forEach(b=> b.onclick=()=>{
        const x = j.vtos.find(x=>x.id===b.getAttribute('data-vto-done')); x.estado='Hecho'; save();
      });
      $$('[data-vto-del]').forEach(b=> b.onclick=()=>{
        if(!confirm('¬øEliminar vencimiento?')) return;
        const ix = j.vtos.findIndex(x=>x.id===b.getAttribute('data-vto-del'));
        if(ix>=0){ j.vtos.splice(ix,1); save(); }
      });
    }

    function diasRestantes(fechaISO){
      const hoy = new Date(); hoy.setHours(0,0,0,0);
      const f = new Date(fechaISO); f.setHours(0,0,0,0);
      return Math.round((f - hoy) / 86400000);
    }

    /* =================== Agenda global =================== */
    function renderAgenda(){
      const dias = Number($('#agendaDias').value||30);
      const hoy = new Date(); hoy.setHours(0,0,0,0);
      const hasta = new Date(hoy.getTime() + (dias*86400000));
      const items = [];
      state.juicios.forEach(j=>{
        j.vtos.forEach(v=>{
          const f = new Date(v.fecha); f.setHours(0,0,0,0);
          if(f>=hoy && f<=hasta){ items.push({ j, v, f }); }
        })
      });
      items.sort((a,b)=> a.f - b.f);
      const body = $('#agendaBody'); body.innerHTML='';
      items.forEach(({j,v})=>{
        const dias = diasRestantes(v.fecha);
        const estadoColor = v.estado==='Hecho' ? 'ok-text' : (dias<0 ? 'danger-text' : (dias<=v.anticipar ? 'warn-text' : ''));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(v.fecha)}</td>
          <td><button class="btn" data-open="${j.id}">${j.actor} vs ${j.demandado}</button></td>
          <td>${v.detalle||'-'}</td>
          <td>${v.anticipar||0} d</td>
          <td class="${estadoColor}">${v.estado}${v.estado!=='Hecho' ? ` (${dias} d√≠as)` : ''}</td>
        `;
        body.appendChild(tr);
      });
      $('#agendaVacia').classList.toggle('hidden', items.length>0);
      $$('[data-open]').forEach(b=> b.onclick = ()=> selectJuicio(b.getAttribute('data-open')));
    }
    $('#btnRefrescarAgenda').onclick = renderAgenda;

    /* =================== Cuadernos de prueba =================== */
    $('#btnAddCuaderno').onclick = ()=>{
      if(!currentId) return alert('Primero abr√≠ un expediente.');
      $('#formCuaderno').reset();
      $('#dlgCuaderno').showModal();
    }
    $('#dlgCuaderno').addEventListener('close', ()=>{
      if($('#dlgCuaderno').returnValue!=="ok") return;
      const j = state.juicios.find(x=>x.id===currentId);
      const fd = new FormData($('#formCuaderno'));
      const c = Object.fromEntries(fd.entries()); c.id = uid();
      c.docs = []; // adjuntos simples (URLs temporales dentro de la sesi√≥n)
      j.cuadernos.push(c); save();
    });

    function renderCuadernos(j){
      const cont = $('#listaCuadernos'); cont.innerHTML='';
      $('#emptyCua').classList.toggle('hidden', j.cuadernos.length>0);
      j.cuadernos.forEach(c=>{
        const row = document.createElement('div'); row.className='row';
        row.innerHTML = `
          <div class="meta">
            <span class="tag">${c.tipo}</span>
            <strong>${c.nombre||'-'}</strong>
            <span class="muted-text">${(c.notas||'').slice(0,80)}</span>
          </div>
          <div class="meta">
            <label class="btn" for="file-${c.id}">Adjuntar PDF</label>
            <input id="file-${c.id}" type="file" class="hidden" accept="application/pdf" />
            <button class="btn" data-ver="${c.id}">Ver</button>
            <button class="btn danger" data-delc="${c.id}">Eliminar</button>
          </div>
        `;
        cont.appendChild(row);
        const file = $('#file-'+c.id);
        file.onchange = ()=>{
          const f = file.files[0]; if(!f) return;
          c.docs.push({name:f.name,url:URL.createObjectURL(f)}); save();
        }
      });
      $$('[data-ver]').forEach(b=> b.onclick = ()=>{
        const c = j.cuadernos.find(x=>x.id===b.getAttribute('data-ver'));
        if(!c) return;
        const html = `<h3 style="margin-top:0">${c.tipo} ‚Äì ${c.nombre||''}</h3>`+
          `<div class='muted-text' style='margin:6px 0 12px'>${c.notas||''}</div>`+
          (c.docs.length? c.docs.map(d=>`<div class='row'><div>${d.name}</div><a class='btn' target='_blank' href='${d.url}'>Abrir</a></div>`).join('') : `<div class='empty'>Sin adjuntos</div>`);
        const w = window.open('', '_blank');
        w.document.write(`<body style='background:#0b122b;color:#e5e7eb;font-family:system-ui;padding:16px'>${html}</body>`);
      });
      $$('[data-delc]').forEach(b=> b.onclick = ()=>{
        if(!confirm('¬øEliminar cuaderno?')) return;
        const ix = j.cuadernos.findIndex(x=>x.id===b.getAttribute('data-delc'));
        if(ix>=0){ j.cuadernos.splice(ix,1); save(); }
      });
    }

    /* =================== Escritos =================== */
    $('#btnExportDoc').onclick = ()=>{
      const titulo = $('#escTitulo').value || 'Escrito';
      const blob = new Blob([$('#escContenido').value||''], {type:'text/plain'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `${titulo}.txt`; a.click();
    };

    $('#btnAdjuntarEscrito').onclick = ()=>{
      if(!currentId) return alert('Abr√≠ un expediente para asociar el escrito.');
      const j = state.juicios.find(x=>x.id===currentId);
      if(!j.movs.length) return alert('Primero cre√° un movimiento para asociar el escrito.');
      const m = j.movs[0]; // √∫ltimo
      m.texto = (m.texto||'') + '\n\n' + ($('#escTitulo').value? ('T√çTULO: '+$('#escTitulo').value+'\n') : '') + ($('#escContenido').value||'');
      save(); alert('Escrito asociado al √∫ltimo movimiento.');
    };

    /* =================== Import/Export/Backup =================== */
    $('#btnExport').onclick = ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `legal-mvp-${new Date().toISOString().slice(0,10)}.json`; a.click();
    };
    $('#btnBackup').onclick = ()=> $('#btnExport').click();
    $('#importFile').onchange = (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{ try{ const data = JSON.parse(reader.result); if(confirm('Esto reemplazar√° tus datos locales. ¬øContinuar?')){ Object.assign(state, data); save(); alert('Importaci√≥n exitosa.'); } }catch(err){ alert('Archivo no v√°lido'); } };
      reader.readAsText(f);
    };

    $('#btnBorrarTodo').onclick = ()=>{
      if(!confirm('¬øBorrar TODOS los datos locales?')) return;
      localStorage.removeItem(DB_KEY);
      state.juicios = []; save(); render(); alert('Datos borrados del navegador.');
    }

    /* =================== Render principal =================== */
    function render(){
      renderJuicios();
      if(currentId){ selectJuicio(currentId); }
      renderAgenda();
      refreshAtajos();
    }

    /* =================== Inicializaci√≥n =================== */
    load();
    render();
  </script>
</body>
</html>
