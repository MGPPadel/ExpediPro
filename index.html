<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ExpediPro - La Gestion Legal Mas Simple</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #111827; }
    .modal-content { max-height: 85vh; overflow-y: auto; transform-origin: center top; }
    .toast { position: fixed; bottom: 20px; right: 20px; color: white; padding: 12px 18px; border-radius: 10px; opacity: 0; transform: translateY(8px); transition: opacity .25s ease, transform .25s ease; z-index: 100; pointer-events: none; }
    .toast.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .toast.success { background: #16a34a; }
    .toast.error { background: #dc2626; }
    .toast.warn { background: #d97706; }
    .input-error { color: #fb7185; font-size: .85rem; margin-top: .25rem; }
    .modal-card { transition: transform .18s ease, opacity .18s ease; transform: translateY(-8px) scale(.995); opacity: 0; }
    .modal-enter { transform: translateY(0) scale(1); opacity: 1; }
    .modal-exit { transform: translateY(-8px) scale(.995); opacity: 0; }
    tr.hover-row:hover { background-color: rgba(255,255,255,0.03); }
    .required-dot::after { content: " *"; color: #fb7185; margin-left: 2px; font-weight: 700; }
    #movement-list li, #prueba-movement-list li { transition: background-color .15s ease, transform .12s ease; }
    #movement-list li:hover, #prueba-movement-list li:hover { transform: translateY(-2px); }
    .file-pill { background:#374151; color:#e5e7eb; padding:6px 10px; border-radius:8px; display:inline-flex; align-items:center; margin:4px; gap:8px; }
    .file-pill button { background:transparent; border:none; color:#f87171; font-weight:700; cursor:pointer; }
    .file-link { color:#93c5fd; text-decoration:underline; margin-right:8px; }
    .tab-btn { padding: 8px 16px; border-radius: 8px; font-weight: 500; transition: background-color .2s ease, color .2s ease; }
    .tab-btn.active { background-color: #374151; color: #f9fafb; }
    .tab-btn:not(.active) { color: #9ca3af; }
    .sortable-header { cursor: pointer; user-select: none; }
    .sortable-header:hover { color: #e5e7eb; }
    .sort-icon { display: inline-block; width: 1em; height: 1em; margin-left: 4px; opacity: 0.5; }
    .ql-toolbar { border-top-left-radius: 8px; border-top-right-radius: 8px; border-color: #4b5563 !important; }
    .ql-container { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; border-color: #4b5563 !important; color: #d1d5db; min-height: 150px; font-size: 1rem; }
    .ql-editor { color: #d1d5db; }
    .ql-snow .ql-stroke { stroke: #9ca3af; }
    .ql-snow .ql-picker-label { color: #9ca3af; }
    .ql-snow .ql-picker-options { background-color: #374151; border-color: #4b5563; }
    .formatted-content { color: #d1d5db; }
    .formatted-content h1, .formatted-content h2 { font-weight: bold; }
    .formatted-content ul { list-style-type: disc; padding-left: 2rem; }
    .formatted-content ol { list-style-type: decimal; padding-left: 2rem; }
    .dashboard-card { background-color: #1f2937; border-radius: 0.75rem; padding: 1.5rem; }
    #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .calendar-day { background-color: #374151; border-radius: 0.5rem; padding: 0.75rem; min-height: 100px; position: relative; display: flex; flex-direction: column; justify-content: space-between; }
    .calendar-day.other-month { background-color: #1f2937; color: #6b7280; }
    .calendar-day.has-events { cursor: pointer; transition: background-color .2s ease; }
    .calendar-day.has-events:hover { background-color: #4b5563; }
    .calendar-day-header { font-weight: 600; }
    .event-indicator-container { display: flex; flex-direction: column; gap: 3px; }
    .event-indicator { height: 5px; border-radius: 10px; }
    .event-vencimiento { background-color: #3b82f6; } /* Blue */
    .event-tarea { background-color: #f59e0b; } /* Amber */
    .task-completed { text-decoration: line-through; color: #6b7280; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="text-gray-200">

  <!-- Vista de Autenticaci√≥n -->
  <div id="auth-view">
    <div class="min-h-screen flex items-center justify-center bg-gray-900">
      <div class="max-w-md w-full bg-gray-800 p-8 rounded-xl shadow-lg">
        <img src="https://i.postimg.cc/RFVHhQcb/LOGO-SIN-FONDO-LETRA-BLANCA.png" alt="ExpediPro Logo" class="h-12 mx-auto mb-6">
        
        <!-- Formulario de Inicio de Sesi√≥n -->
        <form id="login-form">
          <h2 class="text-2xl font-bold text-center text-white mb-6">Iniciar Sesi√≥n</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-300">Email</label>
              <input type="email" id="login-email" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            </div>
            <div>
              <label class="block text-sm text-gray-300">Contrase√±a</label>
              <input type="password" id="login-password" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            </div>
          </div>
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg mt-6">Ingresar</button>
          <div class="text-center mt-4">
            <a href="#" id="forgot-password-link" class="text-sm text-blue-400 hover:underline">¬øOlvidaste tu contrase√±a?</a>
          </div>
          <p class="text-center text-sm text-gray-400 mt-4">
            ¬øNo tienes una cuenta? <a href="#" id="show-register-link" class="text-blue-400 hover:underline">Reg√≠strate</a>
          </p>
        </form>

        <!-- Formulario de Registro -->
        <form id="register-form" class="hidden">
          <h2 class="text-2xl font-bold text-center text-white mb-6">Crear Cuenta</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm text-gray-300">Email</label>
              <input type="email" id="register-email" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            </div>
            <div>
              <label class="block text-sm text-gray-300">Contrase√±a</label>
              <input type="password" id="register-password" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            </div>
          </div>
          <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg mt-6">Registrarse</button>
          <p class="text-center text-sm text-gray-400 mt-4">
            ¬øYa tienes una cuenta? <a href="#" id="show-login-link" class="text-blue-400 hover:underline">Inicia Sesi√≥n</a>
          </p>
        </form>
      </div>
    </div>
  </div>

  <!-- Vista Principal de la Aplicaci√≥n -->
  <div id="app-view" class="hidden container mx-auto p-4 md:p-8">
    <header class="flex justify-between items-center mb-6">
        <img src="https://i.postimg.cc/RFVHhQcb/LOGO-SIN-FONDO-LETRA-BLANCA.png" alt="Exped-Pro Logo" class="h-10">
        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Cerrar Sesi√≥n</button>
    </header>

    <div class="mb-6 flex items-center border-b border-gray-700">
      <div class="flex space-x-2 flex-wrap">
        <button id="tab-dashboard" class="tab-btn active">Dashboard</button>
        <button id="tab-casos" class="tab-btn">Casos</button>
        <button id="tab-vencimientos" class="tab-btn">Vencimientos</button>
        <button id="tab-facturacion" class="tab-btn">Facturaci√≥n</button>
        <button id="tab-calendario" class="tab-btn">Calendario</button>
        <button id="tab-tareas" class="tab-btn">Tareas</button>
        <button id="tab-contactos" class="tab-btn">Contactos</button>
        <button id="tab-perfil" class="tab-btn">Perfil</button>
      </div>
    </div>

    <!-- Contenido de las vistas -->
    <div id="dashboard-view">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-white">Panel Principal</h1>
            <p class="text-gray-400">Resumen de la actividad de su estudio.</p>
        </header>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="space-y-6">
                <div class="dashboard-card">
                    <h2 class="text-xl font-semibold text-white mb-4">Vencimientos Pr√≥ximos (7 d√≠as)</h2>
                    <div id="dashboard-vencimientos" class="space-y-3"></div>
                </div>
                <div class="dashboard-card">
                    <h2 class="text-xl font-semibold text-white mb-4">√öltimos Movimientos</h2>
                    <div id="dashboard-movimientos" class="space-y-3"></div>
                </div>
            </div>
            <div class="space-y-6">
                <div class="dashboard-card">
                    <h2 class="text-xl font-semibold text-white mb-4">Tareas Pendientes</h2>
                    <div id="dashboard-tareas" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="casos-view" class="hidden">
      <header class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">Gesti√≥n de Casos Jur√≠dicos</h1>
        <button id="addCaseBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Agregar Caso</button>
      </header>
      <div class="mb-4">
        <input type="text" id="search-casos" placeholder="üîé Buscar por expediente, car√°tula, fuero..." class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
      </div>
      <main class="bg-gray-800 rounded-lg shadow overflow-hidden">
        <table class="w-full text-sm text-left text-gray-400">
          <thead class="bg-gray-700 text-gray-300 uppercase text-xs">
            <tr>
              <th class="px-6 py-3 sortable-header" data-sort="expediente">N¬∞ Expediente <span class="sort-icon"></span></th>
              <th class="px-6 py-3 sortable-header" data-sort="caratula">Car√°tula <span class="sort-icon"></span></th>
              <th class="px-6 py-3 sortable-header" data-sort="fuero">Fuero <span class="sort-icon"></span></th>
              <th class="px-6 py-3 sortable-header" data-sort="juzgado">Nominaci√≥n <span class="sort-icon"></span></th>
              <th class="px-6 py-3 text-center">Acciones</th>
            </tr>
          </thead>
          <tbody id="case-list-body"></tbody>
        </table>
      </main>
    </div>
    <div id="contactos-view" class="hidden">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">Agenda de Contactos</h1>
            <button id="addContactoBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Agregar Contacto</button>
        </header>
        <main class="bg-gray-800 rounded-lg shadow overflow-hidden">
            <table class="w-full text-sm text-left text-gray-400">
                <thead class="bg-gray-700 text-gray-300 uppercase text-xs">
                    <tr>
                        <th class="px-6 py-3">Nombre y Apellido</th>
                        <th class="px-6 py-3">Tel√©fono</th>
                        <th class="px-6 py-3">Email</th>
                        <th class="px-6 py-3">DNI</th>
                        <th class="px-6 py-3 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="contacto-list-body"></tbody>
            </table>
        </main>
    </div>
    <div id="calendario-view" class="hidden">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">Calendario Jur√≠dico</h1>
            <div class="flex items-center space-x-4">
                <button id="prev-month-btn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg">‚Äπ Anterior</button>
                <h2 id="calendar-month-year" class="text-xl font-semibold text-white"></h2>
                <button id="next-month-btn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg">Siguiente ‚Ä∫</button>
            </div>
        </header>
        <main class="bg-gray-800 rounded-lg shadow p-4">
            <div id="calendar-weekdays" class="grid grid-cols-7 gap-4 text-center text-xs text-gray-400 uppercase pb-2 mb-2 border-b border-gray-700">
                <div>Domingo</div><div>Lunes</div><div>Martes</div><div>Mi√©rcoles</div><div>Jueves</div><div>Viernes</div><div>S√°bado</div>
            </div>
            <div id="calendar-grid"></div>
        </main>
    </div>
    <div id="tareas-view" class="hidden">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">Gesti√≥n de Tareas</h1>
            <button id="addTareaBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Agregar Tarea</button>
        </header>
        <main class="bg-gray-800 rounded-lg shadow overflow-hidden">
            <table class="w-full text-sm text-left text-gray-400">
                <thead class="bg-gray-700 text-gray-300 uppercase text-xs">
                    <tr>
                        <th class="px-6 py-3 w-12">Estado</th>
                        <th class="px-6 py-3">Descripci√≥n</th>
                        <th class="px-6 py-3">Caso Vinculado</th>
                        <th class="px-6 py-3">Fecha L√≠mite</th>
                        <th class="px-6 py-3 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tarea-list-body"></tbody>
            </table>
        </main>
    </div>
    <div id="vencimientos-view" class="hidden">
      <header class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">Gesti√≥n de Vencimientos</h1>
        <button id="addVencimientoBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Agregar Vencimiento</button>
      </header>
      <main class="bg-gray-800 rounded-lg shadow overflow-hidden">
        <table class="w-full text-sm text-left text-gray-400">
          <thead class="bg-gray-700 text-gray-300 uppercase text-xs">
            <tr>
              <th class="px-6 py-3">T√≠tulo / Motivo</th>
              <th class="px-6 py-3">Expediente Vinculado</th>
              <th class="px-6 py-3">Fecha Vencimiento</th>
              <th class="px-6 py-3">Recordatorio</th>
              <th class="px-6 py-3 text-right">Acciones</th>
            </tr>
          </thead>
          <tbody id="vencimiento-list-body"></tbody>
        </table>
      </main>
    </div>
    <div id="facturacion-view" class="hidden">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-white">Facturaci√≥n General</h1>
            <button id="addFacturacionBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Agregar Item</button>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 p-4 rounded-lg"><h4 class="text-gray-400 text-sm">Total Facturado</h4><p id="total-facturado" class="text-2xl font-bold text-white"></p></div>
            <div class="bg-gray-800 p-4 rounded-lg"><h4 class="text-gray-400 text-sm">Total Cobrado</h4><p id="total-cobrado" class="text-2xl font-bold text-green-400"></p></div>
            <div class="bg-gray-800 p-4 rounded-lg"><h4 class="text-gray-400 text-sm">Total Pendiente</h4><p id="total-pendiente" class="text-2xl font-bold text-yellow-400"></p></div>
        </div>
        <main class="bg-gray-800 rounded-lg shadow overflow-hidden">
            <table class="w-full text-sm text-left text-gray-400">
                <thead class="bg-gray-700 text-gray-300 uppercase text-xs">
                    <tr>
                        <th class="px-6 py-3">Concepto</th>
                        <th class="px-6 py-3">Caso Vinculado</th>
                        <th class="px-6 py-3">Fecha</th>
                        <th class="px-6 py-3">Monto</th>
                        <th class="px-6 py-3">Estado</th>
                        <th class="px-6 py-3 text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="facturacion-list-body"></tbody>
            </table>
        </main>
    </div>
    <div id="perfil-view" class="hidden">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-white">Mi Perfil</h1>
            <p class="text-gray-400">Gestiona tu informaci√≥n personal y de seguridad.</p>
        </header>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Formulario de Datos Personales -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-white mb-4">Datos Personales</h2>
                <form id="profile-form" class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-300">Email</label>
                        <p id="profile-email" class="text-gray-400 mt-1"></p>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300">Nombre</label>
                        <input type="text" id="profile-nombre" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300">Apellido</label>
                        <input type="text" id="profile-apellido" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg mt-2">Guardar Cambios</button>
                </form>
            </div>
            <!-- Formulario de Cambio de Contrase√±a -->
            <div class="bg-gray-800 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-white mb-4">Cambiar Contrase√±a</h2>
                <form id="password-change-form" class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-300">Nueva Contrase√±a</label>
                        <input type="password" id="profile-new-password" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300">Confirmar Nueva Contrase√±a</label>
                        <input type="password" id="profile-confirm-password" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg mt-2">Cambiar Contrase√±a</button>
                </form>
            </div>
        </div>
    </div>
  </div>

  <div id="toast" class="toast success">Acci√≥n realizada</div>

  <!-- Modales de la aplicaci√≥n -->
  <div id="day-events-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content p-6 modal-card">
      <div class="flex justify-between items-start mb-4">
        <h2 id="day-events-title" class="text-xl font-bold text-white">Eventos del D√≠a</h2>
        <button id="close-day-events-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <div id="day-events-list" class="space-y-3"></div>
    </div>
  </div>
  <div id="case-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content p-6 modal-card">
      <div class="flex justify-between items-start mb-2">
        <h2 id="case-modal-title" class="text-xl font-bold text-white">Agregar Nuevo Caso</h2>
        <button id="x-case-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <form id="case-form" class="space-y-4">
        <input type="hidden" id="case-id">
        <div>
          <label class="block text-sm text-gray-300 required-dot">Actor</label>
          <input type="text" id="case-actorNombre" placeholder="Nombre completo del actor" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Demandado</label>
          <input type="text" id="case-demandadoNombre" placeholder="Nombre completo del demandado" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">N¬∞ Expediente</label>
          <input type="text" id="case-expediente" placeholder="N¬∞ Expediente" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300">Objeto del juicio</label>
          <input type="text" id="case-objeto" placeholder="Objeto del juicio" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Fuero</label>
          <select id="case-fuero" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            <option value="" disabled selected>Seleccionar fuero</option>
            <option value="Laboral">Laboral</option>
            <option value="Civil">Civil</option>
            <option value="Familia">Familia</option>
            <option value="Penal">Penal</option>
            <option value="Otro">Otro</option>
          </select>
          <input type="text" id="case-fuero-otro" placeholder="Si es otro, especifique" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 hidden mt-2">
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Nominaci√≥n</label>
          <input type="text" id="case-juzgado" placeholder="Juzgado donde est√° radicado" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300">Provincia / Ciudad</label>
          <input type="text" id="case-provincia" placeholder="Provincia / Ciudad" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
        </div>
        <div>
          <label class="block text-sm text-gray-300">Abogado de la otra parte</label>
          <input type="text" id="case-abogado" placeholder="Abogado de la otra parte" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
        </div>
        <div>
          <label class="block text-sm text-gray-300">Tel√©fono del abogado</label>
          <input type="text" id="case-telefono" placeholder="Tel√©fono del abogado" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
        </div>
        <div class="flex justify-end space-x-4 pt-2">
          <button type="button" id="cancel-case-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Cancelar</button>
          <button type="submit" id="save-case-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Guardar</button>
        </div>
      </form>
    </div>
  </div>
  <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl modal-content modal-card">
      <div class="p-8">
        <div class="flex justify-between items-start">
          <h2 class="text-2xl font-bold text-white mb-6">Detalles del Expediente</h2>
          <button id="close-details-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
        </div>
        <div id="details-content" class="space-y-2 text-gray-300"></div>
        <div class="mt-8 pt-6 border-t border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">Facturaci√≥n del Caso</h3>
                <div class="flex items-center space-x-4">
                    <button id="generate-report-btn" type="button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Generar Informe (.docx)</button>
                    <button id="add-facturacion-from-case-btn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm">‚ûï Agregar Item</button>
                </div>
            </div>
            <div id="case-facturacion-list" class="space-y-3"></div>
        </div>
        <div class="mt-8 pt-6 border-t border-gray-700">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">Cuadernos de Prueba</h3>
            <button id="add-prueba-btn" type="button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
              ‚ûï Agregar Cuaderno
            </button>
          </div>
          <div id="prueba-list" class="space-y-3"></div>
        </div>
        <div class="mt-8 pt-6 border-t border-gray-700">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-white">Movimientos del Expediente Principal</h3>
            <button id="add-movement-btn" type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
              ‚ûï Agregar Movimiento
            </button>
          </div>
          <ul id="movement-list" class="space-y-4"></ul>
        </div>
      </div>
    </div>
  </div>
  <div id="movement-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl modal-content p-6 modal-card">
      <div class="flex justify-between items-start mb-2">
        <h2 class="text-xl font-bold text-white" id="movement-modal-title">Agregar Movimiento</h2>
        <button id="x-movement-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <form id="movement-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-300 required-dot">Fecha</label>
              <input type="date" id="mov-fecha" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            </div>
            <div>
              <label class="block text-sm text-gray-300 required-dot">Tipo</label>
              <select id="mov-tipo" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                <option value="" disabled selected>Seleccionar tipo</option>
                <option value="escrito">‚úçÔ∏è Escrito</option>
                <option value="decreto">üìú Decreto</option>
                <option value="sentencia">‚öñÔ∏è Sentencia</option>
                <option value="otro">Otro</option>
              </select>
            </div>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Descripci√≥n</label>
          <input type="text" id="mov-descripcion" placeholder="Descripci√≥n corta del movimiento o t√≠tulo del escrito" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300">Detalle / Cuerpo del Escrito</label>
          <div id="mov-detalle-editor" class="bg-gray-900"></div>
        </div>
        <div>
          <label class="block text-sm text-gray-300">Archivos Adjuntos</label>
          <input type="file" id="mov-archivos" multiple class="w-full text-gray-300 mt-1">
          <div id="file-preview" class="mt-2 flex flex-wrap"></div>
        </div>
        <div class="flex justify-end space-x-4 pt-2">
          <button type="button" id="cancel-movement-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Cancelar</button>
          <button type="submit" id="save-movement-btn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg flex items-center justify-center">
            <span class="btn-text">Guardar</span>
            <span class="loader hidden ml-2"></span>
          </button>
        </div>
      </form>
    </div>
  </div>
  <div id="view-movement-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
      <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl modal-content p-6 modal-card">
          <div class="flex justify-between items-start mb-4">
              <h2 class="text-xl font-bold text-white">Detalle del Movimiento</h2>
              <button id="close-view-movement-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
          </div>
          <div id="view-movement-content" class="space-y-4 text-gray-300"></div>
          <div class="flex justify-end space-x-4 mt-6 pt-4 border-t border-gray-700">
              <button id="export-docx-btn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Exportar a .docx</button>
              <button id="edit-mov-from-view-btn" type="button" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Editar</button>
              <button id="delete-mov-from-view-btn" type="button" class="bg-red-800 hover:bg-red-700 text-white py-2 px-4 rounded-lg">Eliminar</button>
          </div>
      </div>
  </div>
  <div id="prueba-form-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content p-6 modal-card">
      <div class="flex justify-between items-start mb-2">
        <h2 id="prueba-modal-title" class="text-xl font-bold text-white">Agregar Cuaderno de Prueba</h2>
        <button id="x-prueba-form-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <form id="prueba-form" class="space-y-4">
        <div>
          <label class="block text-sm text-gray-300 required-dot">Tipo de Prueba</label>
          <select id="prueba-tipo" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            <option value="" disabled selected>Seleccionar tipo</option>
            <option value="Testimonial">Testimonial</option>
            <option value="Pericial">Pericial</option>
            <option value="De Informes">De Informes</option>
            <option value="Otro">Otro</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">T√≠tulo / Descripci√≥n</label>
          <input type="text" id="prueba-titulo" placeholder="Ej: Pericia Contable S.A." class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div class="flex justify-end space-x-4 pt-2">
          <button type="button" id="cancel-prueba-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Cancelar</button>
          <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg">Guardar</button>
        </div>
      </form>
    </div>
  </div>
  <div id="prueba-detail-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
      <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl modal-content modal-card">
          <div class="p-8">
              <div class="flex justify-between items-start mb-4">
                  <div>
                      <h2 id="prueba-detail-title" class="text-2xl font-bold text-white"></h2>
                      <p id="prueba-detail-subtitle" class="text-sm text-gray-400"></p>
                  </div>
                  <button id="close-prueba-detail-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
              </div>
              <div class="mt-8 pt-6 border-t border-gray-700">
                  <div class="flex items-center justify-between mb-4">
                      <h3 class="text-lg font-semibold text-white">Movimientos del Cuaderno de Prueba</h3>
                      <button id="add-prueba-movement-btn" type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                          ‚ûï Agregar Movimiento
                      </button>
                  </div>
                  <ul id="prueba-movement-list" class="space-y-4"></ul>
              </div>
          </div>
      </div>
  </div>
  <div id="vencimiento-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
    <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content p-6 modal-card">
      <div class="flex justify-between items-start mb-2">
        <h2 class="text-xl font-bold text-white" id="vencimiento-modal-title">Agregar Vencimiento</h2>
        <button id="x-vencimiento-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <form id="vencimiento-form" class="space-y-4">
        <input type="hidden" id="vencimiento-id">
        <div>
          <label class="block text-sm text-gray-300 required-dot">T√≠tulo / Motivo</label>
          <input type="text" id="vencimiento-titulo" placeholder="Ej: Audiencia preliminar" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Fecha del vencimiento</label>
          <input type="date" id="vencimiento-fecha" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
        </div>
        <div>
          <label class="block text-sm text-gray-300">Expediente vinculado (opcional)</label>
          <select id="vencimiento-caso-id" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
            <option value="">Ninguno</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-300 required-dot">Recordar con anticipaci√≥n</label>
          <select id="vencimiento-recordatorio" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
            <option value="" disabled selected>Seleccionar d√≠as</option>
            <option value="1">1 d√≠a antes</option>
            <option value="5">5 d√≠as antes</option>
            <option value="10">10 d√≠as antes</option>
          </select>
        </div>
        <div class="flex justify-end space-x-4 pt-2">
          <button type="button" id="cancel-vencimiento-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Cancelar</button>
          <button type="submit" id="save-vencimiento-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Guardar</button>
        </div>
      </form>
    </div>
  </div>
  <div id="facturacion-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content p-6 modal-card">
            <div class="flex justify-between items-start mb-2">
                <h2 id="facturacion-modal-title" class="text-xl font-bold text-white">Agregar Item de Facturaci√≥n</h2>
                <button id="x-facturacion-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="facturacion-form" class="space-y-4">
                <input type="hidden" id="facturacion-id">
                <div>
                    <label class="block text-sm text-gray-300 required-dot">Concepto</label>
                    <input type="text" id="facturacion-concepto" placeholder="Ej: Honorarios Etapa Probatoria" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-300 required-dot">Fecha</label>
                        <input type="date" id="facturacion-fecha" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 required-dot">Monto</label>
                        <input type="number" id="facturacion-monto" placeholder="0.00" step="0.01" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-gray-300 required-dot">Tipo</label>
                        <select id="facturacion-tipo" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                            <option value="Honorarios">Honorarios</option>
                            <option value="Gasto con Comprobante">Gasto con Comprobante</option>
                            <option value="Gasto sin Comprobante">Gasto sin Comprobante</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-300 required-dot">Estado</label>
                        <select id="facturacion-estado" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
                            <option value="Pendiente">Pendiente</option>
                            <option value="Pagado">Pagado</option>
                        </select>
                    </div>
                </div>
                <div id="facturacion-caso-selector-div">
                    <label class="block text-sm text-gray-300">Caso Vinculado</label>
                    <select id="facturacion-caso-id" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5"></select>
                </div>
                <div class="flex justify-end space-x-4 pt-2">
                    <button type="button" id="cancel-facturacion-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Cancelar</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Guardar</button>
                </div>
            </form>
        </div>
    </div>
  <div id="contacto-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
      <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content p-6 modal-card">
          <div class="flex justify-between items-start mb-2">
              <h2 id="contacto-modal-title" class="text-xl font-bold text-white">Agregar Contacto</h2>
              <button id="x-contacto-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
          </div>
          <form id="contacto-form" class="space-y-4">
              <input type="hidden" id="contacto-id">
              <div>
                  <label class="block text-sm text-gray-300 required-dot">Nombre y Apellido</label>
                  <input type="text" id="contacto-nombre" placeholder="Nombre completo" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                      <label class="block text-sm text-gray-300">Tel√©fono</label>
                      <input type="tel" id="contacto-telefono" placeholder="N¬∞ de tel√©fono" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                  </div>
                  <div>
                      <label class="block text-sm text-gray-300">Email</label>
                      <input type="email" id="contacto-email" placeholder="correo@ejemplo.com" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                  </div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                      <label class="block text-sm text-gray-300">DNI</label>
                      <input type="text" id="contacto-dni" placeholder="N¬∞ de DNI" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                  </div>
                  <div>
                      <label class="block text-sm text-gray-300">Domicilio</label>
                      <input type="text" id="contacto-domicilio" placeholder="Direcci√≥n" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                  </div>
              </div>
              <div>
                  <label class="block text-sm text-gray-300">Notas</label>
                  <textarea id="contacto-notas" rows="3" placeholder="Informaci√≥n adicional..." class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5"></textarea>
              </div>
              <div class="flex justify-end space-x-4 pt-2">
                  <button type="button" id="cancel-contacto-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Cancelar</button>
                  <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Guardar</button>
              </div>
          </form>
      </div>
  </div>
  <div id="tarea-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50" aria-hidden="true">
      <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg modal-content p-6 modal-card">
          <div class="flex justify-between items-start mb-2">
              <h2 id="tarea-modal-title" class="text-xl font-bold text-white">Agregar Tarea</h2>
              <button id="x-tarea-btn" type="button" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
          </div>
          <form id="tarea-form" class="space-y-4">
              <input type="hidden" id="tarea-id">
              <div>
                  <label class="block text-sm text-gray-300 required-dot">Descripci√≥n</label>
                  <input type="text" id="tarea-descripcion" placeholder="Ej: Preparar interrogatorio" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5" required>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                      <label class="block text-sm text-gray-300">Fecha L√≠mite</label>
                      <input type="date" id="tarea-fecha" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                  </div>
                  <div>
                      <label class="block text-sm text-gray-300">Estado</label>
                      <select id="tarea-estado" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5">
                          <option value="Pendiente">Pendiente</option>
                          <option value="Completada">Completada</option>
                      </select>
                  </div>
              </div>
              <div>
                  <label class="block text-sm text-gray-300">Caso Vinculado</label>
                  <select id="tarea-caso-id" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5"></select>
              </div>
              <div class="flex justify-end space-x-4 pt-2">
                  <button type="button" id="cancel-tarea-btn" class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-lg">Cancelar</button>
                  <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Guardar</button>
              </div>
          </form>
      </div>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-to-docx@1.8.0/dist/html-to-docx.min.js"></script>
  
  <script type="module">
    // Importar funciones de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged,
      sendPasswordResetEmail,
      updatePassword
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      getDocs, 
      doc, 
      updateDoc, 
      deleteDoc, 
      onSnapshot,
      query,
      where,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // --- CONFIGURACI√ìN DE FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyBMyDgQDU58NZhC4_4jupw1QoVJpKo6QXo",
      authDomain: "abogapp-c3166.firebaseapp.com",
      projectId: "abogapp-c3166",
      storageBucket: "abogapp-c3166.appspot.com",
      messagingSenderId: "138541502606",
      appId: "1:138541502606:web:ec236d8e1a47031bd439df",
      measurementId: "G-K2JH9J257J"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- REFERENCIAS A ELEMENTOS DEL DOM ---
    const authView = document.getElementById('auth-view');
    const appView = document.getElementById('app-view');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const logoutBtn = document.getElementById('logout-btn');
    const showRegisterLink = document.getElementById('show-register-link');
    const showLoginLink = document.getElementById('show-login-link');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const toast = document.getElementById("toast");

    // --- MANEJO DE VISTAS DE AUTENTICACI√ìN ---
    showRegisterLink.addEventListener('click', (e) => {
      e.preventDefault();
      loginForm.classList.add('hidden');
      registerForm.classList.remove('hidden');
    });

    showLoginLink.addEventListener('click', (e) => {
      e.preventDefault();
      registerForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
    });

    // --- L√ìGICA DE AUTENTICACI√ìN ---
    let currentUserId = null;
    
    onAuthStateChanged(auth, user => {
      if (user) {
        // Usuario ha iniciado sesi√≥n
        currentUserId = user.uid;
        authView.classList.add('hidden');
        appView.classList.remove('hidden');
        initialize(); // Iniciar la aplicaci√≥n principal
      } else {
        // Usuario no ha iniciado sesi√≥n
        currentUserId = null;
        authView.classList.remove('hidden');
        appView.classList.add('hidden');
      }
    });

    registerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      createUserWithEmailAndPassword(auth, email, password)
        .then(async (userCredential) => {
          // Crear documento de perfil para el nuevo usuario
          const userRef = doc(db, "users", userCredential.user.uid);
          await setDoc(userRef, {
            nombre: "",
            apellido: ""
          });
          showToast('¬°Cuenta creada con √©xito!', 'success');
        })
        .catch((error) => {
          handleAuthError(error);
        });
    });

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      signInWithEmailAndPassword(auth, email, password)
        .catch((error) => {
          handleAuthError(error);
        });
    });

    logoutBtn.addEventListener('click', () => {
      signOut(auth).catch(error => showToast('Error al cerrar sesi√≥n', 'error'));
    });
    
    forgotPasswordLink.addEventListener('click', (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        if (!email) {
            showToast('Por favor, ingresa tu email para restablecer la contrase√±a.', 'warn');
            return;
        }
        sendPasswordResetEmail(auth, email)
            .then(() => {
                showToast('Se ha enviado un correo para restablecer tu contrase√±a.', 'success');
            })
            .catch((error) => {
                handleAuthError(error);
            });
    });
    
    function handleAuthError(error) {
        console.error("Auth Error:", error.code, error.message);
        switch (error.code) {
            case 'auth/operation-not-allowed':
                showToast('Error: El inicio de sesi√≥n por contrase√±a no est√° habilitado en Firebase.', 'error');
                break;
            case 'auth/email-already-in-use':
                showToast('El correo electr√≥nico ya est√° en uso.', 'error');
                break;
            case 'auth/invalid-email':
                showToast('El formato del correo electr√≥nico no es v√°lido.', 'error');
                break;
            case 'auth/weak-password':
                showToast('La contrase√±a debe tener al menos 6 caracteres.', 'error');
                break;
            case 'auth/invalid-credential':
            case 'auth/user-not-found':
            case 'auth/wrong-password':
                 showToast('Correo electr√≥nico o contrase√±a incorrectos.', 'error');
                 break;
            default:
                showToast('Ocurri√≥ un error. Int√©ntalo de nuevo.', 'error');
        }
    }

    // --- L√ìGICA DE LA APLICACI√ìN ---

    // ---------- DATOS DE LA APLICACI√ìN (Ahora desde Firestore) ----------
    let contactos = [];
    let casos = [];
    let vencimientos = [];
    let facturacion = [];
    let tareas = [];
    
    let unsubContactos, unsubCasos, unsubVencimientos, unsubFacturacion, unsubTareas;

    // ---------- ESTADO DE LA UI ----------
    let currentCaseId = null;
    let currentPruebaId = null;
    let currentMovementIndex = null;
    let movementContext = 'main';
    let caseMode = "create";
    let movementMode = "create";
    let vencimientoMode = "create";
    let pruebaMode = "create";
    let facturacionMode = "create";
    let contactoMode = "create";
    let tareaMode = "create";
    let keptFiles = []; 
    let newFiles = [];
    let sortConfig = { key: 'expediente', direction: 'ascending' };
    let searchQuery = '';
    let quillEditor = null;
    let calendarDate = new Date();

    // ---------- REFERENCIAS DOM (agrupadas por funcionalidad) ----------
    const tabDashboard = document.getElementById("tab-dashboard");
    const tabCasos = document.getElementById("tab-casos");
    const tabContactos = document.getElementById("tab-contactos");
    const tabCalendario = document.getElementById("tab-calendario");
    const tabTareas = document.getElementById("tab-tareas");
    const tabVencimientos = document.getElementById("tab-vencimientos");
    const tabFacturacion = document.getElementById("tab-facturacion");
    const tabPerfil = document.getElementById("tab-perfil");
    const dashboardView = document.getElementById("dashboard-view");
    const casosView = document.getElementById("casos-view");
    const contactosView = document.getElementById("contactos-view");
    const calendarioView = document.getElementById("calendario-view");
    const tareasView = document.getElementById("tareas-view");
    const vencimientosView = document.getElementById("vencimientos-view");
    const facturacionView = document.getElementById("facturacion-view");
    const perfilView = document.getElementById("perfil-view");
    const searchCasosInput = document.getElementById('search-casos');
    const caseListBody = document.getElementById("case-list-body");
    const addCaseBtn = document.getElementById("addCaseBtn");
    const caseModal = document.getElementById("case-modal");
    const xCaseBtn = document.getElementById("x-case-btn");
    const cancelCaseBtn = document.getElementById("cancel-case-btn");
    const caseForm = document.getElementById("case-form");
    const caseModalTitle = document.getElementById("case-modal-title");
    const casosThead = document.querySelector('#casos-view thead');
    const detailsModal = document.getElementById("details-modal");
    const closeDetailsBtn = document.getElementById("close-details-btn");
    const detailsContent = document.getElementById("details-content");
    const movementList = document.getElementById("movement-list");
    const addMovementBtn = document.getElementById("add-movement-btn");
    const movementModal = document.getElementById("movement-modal");
    const xMovementBtn = document.getElementById("x-movement-btn");
    const cancelMovementBtn = document.getElementById("cancel-movement-btn");
    const movementForm = document.getElementById("movement-form");
    const movementModalTitle = document.getElementById("movement-modal-title");
    const movArchivosInput = document.getElementById("mov-archivos");
    const filePreview = document.getElementById("file-preview");
    const viewMovementModal = document.getElementById('view-movement-modal');
    const closeViewMovementBtn = document.getElementById('close-view-movement-btn');
    const viewMovementContent = document.getElementById('view-movement-content');
    const exportDocxBtn = document.getElementById('export-docx-btn');
    const editMovFromViewBtn = document.getElementById('edit-mov-from-view-btn');
    const deleteMovFromViewBtn = document.getElementById('delete-mov-from-view-btn');
    const addPruebaBtn = document.getElementById('add-prueba-btn');
    const pruebaList = document.getElementById('prueba-list');
    const pruebaFormModal = document.getElementById('prueba-form-modal');
    const pruebaModalTitle = document.getElementById('prueba-modal-title');
    const xPruebaFormBtn = document.getElementById('x-prueba-form-btn');
    const cancelPruebaBtn = document.getElementById('cancel-prueba-btn');
    const pruebaForm = document.getElementById('prueba-form');
    const pruebaDetailModal = document.getElementById('prueba-detail-modal');
    const closePruebaDetailBtn = document.getElementById('close-prueba-detail-btn');
    const pruebaDetailTitle = document.getElementById('prueba-detail-title');
    const pruebaDetailSubtitle = document.getElementById('prueba-detail-subtitle');
    const pruebaMovementList = document.getElementById('prueba-movement-list');
    const addPruebaMovementBtn = document.getElementById('add-prueba-movement-btn');
    const addVencimientoBtn = document.getElementById("addVencimientoBtn");
    const vencimientoListBody = document.getElementById("vencimiento-list-body");
    const vencimientoModal = document.getElementById("vencimiento-modal");
    const xVencimientoBtn = document.getElementById("x-vencimiento-btn");
    const cancelVencimientoBtn = document.getElementById("cancel-vencimiento-btn");
    const vencimientoForm = document.getElementById("vencimiento-form");
    const vencimientoModalTitle = document.getElementById("vencimiento-modal-title");
    const vencimientoCasoIdSelect = document.getElementById("vencimiento-caso-id");
    const addFacturacionBtn = document.getElementById('addFacturacionBtn');
    const facturacionListBody = document.getElementById('facturacion-list-body');
    const facturacionModal = document.getElementById('facturacion-modal');
    const xFacturacionBtn = document.getElementById('x-facturacion-btn');
    const cancelFacturacionBtn = document.getElementById('cancel-facturacion-btn');
    const facturacionForm = document.getElementById('facturacion-form');
    const facturacionModalTitle = document.getElementById('facturacion-modal-title');
    const addFacturacionFromCaseBtn = document.getElementById('add-facturacion-from-case-btn');
    const caseFacturacionList = document.getElementById('case-facturacion-list');
    const generateReportBtn = document.getElementById('generate-report-btn');
    const addContactoBtn = document.getElementById('addContactoBtn');
    const contactoListBody = document.getElementById('contacto-list-body');
    const contactoModal = document.getElementById('contacto-modal');
    const xContactoBtn = document.getElementById('x-contacto-btn');
    const cancelContactoBtn = document.getElementById('cancel-contacto-btn');
    const contactoForm = document.getElementById('contacto-form');
    const contactoModalTitle = document.getElementById('contacto-modal-title');
    const calendarMonthYear = document.getElementById('calendar-month-year');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    const calendarGrid = document.getElementById('calendar-grid');
    const addTareaBtn = document.getElementById('addTareaBtn');
    const tareaListBody = document.getElementById('tarea-list-body');
    const tareaModal = document.getElementById('tarea-modal');
    const xTareaBtn = document.getElementById('x-tarea-btn');
    const cancelTareaBtn = document.getElementById('cancel-tarea-btn');
    const tareaForm = document.getElementById('tarea-form');
    const tareaModalTitle = document.getElementById('tarea-modal-title');
    const profileForm = document.getElementById('profile-form');
    const passwordChangeForm = document.getElementById('password-change-form');
    const dayEventsModal = document.getElementById('day-events-modal');
    const closeDayEventsBtn = document.getElementById('close-day-events-btn');
    
    // ---------- UTILIDADES ----------
    const allModals = [caseModal, detailsModal, movementModal, vencimientoModal, pruebaFormModal, pruebaDetailModal, viewMovementModal, facturacionModal, contactoModal, tareaModal, dayEventsModal];
    function anyModalOpen() { return !allModals.every(m => m.classList.contains('hidden')); }
    function lockScroll() { document.body.style.overflow = 'hidden'; }
    function unlockScroll() { document.body.style.overflow = ''; }

    function openModal(el) {
      el.classList.remove('hidden');
      const card = el.querySelector('.modal-card');
      if (card) {
        card.classList.remove('modal-exit');
        requestAnimationFrame(() => card.classList.add('modal-enter'));
      }
      lockScroll();
    }

    function closeModal(el) {
      const card = el.querySelector('.modal-card');
      if (card) {
        card.classList.remove('modal-enter');
        card.classList.add('modal-exit');
        setTimeout(() => {
          el.classList.add('hidden');
          card.classList.remove('modal-exit');
          if (!anyModalOpen()) unlockScroll();
        }, 180);
      } else {
        el.classList.add('hidden');
        if (!anyModalOpen()) unlockScroll();
      }
    }

    allModals.forEach(modal => {
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal); });
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === "Escape") { allModals.forEach(m => closeModal(m)); }
    });

    let toastTimeout = null;
    function showToast(msg = "Acci√≥n realizada", type = "success", ms = 2600) {
      toast.textContent = msg;
      toast.className = 'toast ' + type + ' show';
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, ms);
    }

    function clearFieldError(input) {
      if (!input) return;
      const next = input.nextElementSibling;
      if (next && next.classList.contains('input-error')) next.remove();
      input.classList.remove('border-red-400');
    }
    function showFieldError(input, msg) {
      if (!input) return;
      clearFieldError(input);
      const div = document.createElement('div');
      div.className = 'input-error';
      div.textContent = msg;
      input.classList.add('border-red-400');
      input.parentNode.insertBefore(div, input.nextSibling);
    }
    function clearAllErrors(form) {
      form.querySelectorAll('.input-error').forEach(el => el.remove());
      form.querySelectorAll('input, select, textarea').forEach(i => i.classList.remove('border-red-400'));
    }
    
    function normalizeString(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    }

    // ---------- NAVEGACI√ìN POR PESTA√ëAS ----------
    function switchTab(tabName) {
        const views = { 'dashboard': dashboardView, 'casos': casosView, 'contactos': contactosView, 'calendario': calendarioView, 'tareas': tareasView, 'vencimientos': vencimientosView, 'facturacion': facturacionView, 'perfil': perfilView };
        const tabs = { 'dashboard': tabDashboard, 'casos': tabCasos, 'contactos': tabContactos, 'calendario': tabCalendario, 'tareas': tabTareas, 'vencimientos': tabVencimientos, 'facturacion': tabFacturacion, 'perfil': tabPerfil };
        
        Object.keys(views).forEach(key => {
            views[key].classList.toggle('hidden', key !== tabName);
            tabs[key].classList.toggle('active', key === tabName);
        });
        if (tabName === 'dashboard') renderDashboard();
        if (tabName === 'calendario') renderCalendar();
        if (tabName === 'perfil') renderProfile();
    }
    tabDashboard.addEventListener('click', () => switchTab('dashboard'));
    tabCasos.addEventListener('click', () => switchTab('casos'));
    tabContactos.addEventListener('click', () => switchTab('contactos'));
    tabCalendario.addEventListener('click', () => switchTab('calendario'));
    tabTareas.addEventListener('click', () => switchTab('tareas'));
    tabVencimientos.addEventListener('click', () => switchTab('vencimientos'));
    tabFacturacion.addEventListener('click', () => switchTab('facturacion'));
    tabPerfil.addEventListener('click', () => switchTab('perfil'));

    // ---------- RENDERIZADO Y L√ìGICA DE VISTAS ----------
    function updateCasesView() {
        let filteredCasos = [...casos];
        if (searchQuery) {
            const normalizedQuery = normalizeString(searchQuery.toLowerCase());
            filteredCasos = filteredCasos.filter(c => {
                const caratula = normalizeString(`${c.actorNombre} vs. ${c.demandadoNombre}`.toLowerCase());
                return normalizeString(c.expediente.toLowerCase()).includes(normalizedQuery) ||
                       caratula.includes(normalizedQuery) ||
                       normalizeString(c.fuero.toLowerCase()).includes(normalizedQuery) ||
                       normalizeString(c.juzgado.toLowerCase()).includes(normalizedQuery);
            });
        }
        filteredCasos.sort((a, b) => {
            let valA, valB;
            if (sortConfig.key === 'caratula') {
                valA = `${a.actorNombre} vs. ${a.demandadoNombre}`;
                valB = `${b.actorNombre} vs. ${b.demandadoNombre}`;
            } else {
                 valA = a[sortConfig.key];
                 valB = b[sortConfig.key];
            }
            valA = String(valA).toLowerCase();
            valB = String(valB).toLowerCase();
            if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
            if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
            return 0;
        });
        renderCases(filteredCasos);
        updateSortIcons();
    }

    function renderCases(casosToRender) {
      caseListBody.innerHTML = "";
      casosToRender.forEach(c => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700 hover-row";
        tr.dataset.id = c.id;
        tr.innerHTML = `
          <td class="px-6 py-4">${c.expediente}</td>
          <td class="px-6 py-4">${c.actorNombre} vs. ${c.demandadoNombre}</td>
          <td class="px-6 py-4">${c.fuero}</td>
          <td class="px-6 py-4">${c.juzgado}</td>
          <td class="px-6 py-4 text-right">
            <div class="flex justify-end items-center space-x-2">
                <button class="view-btn bg-blue-600 hover:bg-blue-500 text-white text-xs px-2.5 py-1 rounded-md">Ver</button>
                <button class="edit-case-btn bg-gray-600 hover:bg-gray-500 text-white text-xs px-2.5 py-1 rounded-md">Editar</button>
                <button class="delete-case-btn bg-red-800 hover:bg-red-700 text-white text-xs px-2.5 py-1 rounded-md">Borrar</button>
            </div>
          </td>
        `;
        caseListBody.appendChild(tr);
      });
    }
    
    function updateSortIcons() {
        document.querySelectorAll('.sortable-header .sort-icon').forEach(icon => icon.textContent = '');
        const activeHeader = document.querySelector(`.sortable-header[data-sort="${sortConfig.key}"] .sort-icon`);
        if (activeHeader) {
            activeHeader.textContent = sortConfig.direction === 'ascending' ? '‚ñ≤' : '‚ñº';
        }
    }

    function renderMovements(movementsArray, listElement) {
        listElement.innerHTML = "";
        if (!movementsArray || movementsArray.length === 0) {
            listElement.innerHTML = "<p class='text-gray-400'>Sin movimientos registrados.</p>";
            return;
        }
        movementsArray.forEach((m, index) => {
            const li = document.createElement("li");
            li.className = "bg-gray-700 p-4 rounded-lg shadow cursor-pointer";
            li.dataset.index = index;
            const filesCount = (m.archivos && m.archivos.length) ? m.archivos.length : 0;
            li.innerHTML = `
              <div class="flex justify-between items-center">
                <span class="font-semibold text-white">${m.fecha}</span>
                <div class="flex items-center gap-3">
                  <span class="px-2 py-1 text-xs rounded ${m.tipo === "sentencia" ? "bg-red-600" : m.tipo === "decreto" ? "bg-blue-600" : "bg-green-600"}">
                    ${m.tipo}
                  </span>
                  ${filesCount ? `<span class="text-xs text-gray-300">${filesCount} archivo(s)</span>` : ""}
                </div>
              </div>
              <p class="text-gray-300 mt-1">${m.descripcion}</p>
            `;
            listElement.appendChild(li);
        });
    }

    function renderVencimientos() {
        vencimientoListBody.innerHTML = "";
        vencimientos.forEach(v => {
            const casoVinculado = v.casoId ? casos.find(c => c.id === v.casoId) : null;
            const tr = document.createElement("tr");
            tr.className = "border-b border-gray-700 hover-row";
            tr.dataset.id = v.id;
            tr.innerHTML = `
                <td class="px-6 py-4">${v.titulo}</td>
                <td class="px-6 py-4">${casoVinculado ? `${casoVinculado.expediente} (${casoVinculado.actorNombre} vs ${casoVinculado.demandadoNombre})` : "‚Äî"}</td>
                <td class="px-6 py-4">${v.fecha}</td>
                <td class="px-6 py-4">${v.recordatorio} d√≠as antes</td>
                <td class="px-6 py-4 text-right">
                    <div class="flex justify-end items-center space-x-2">
                        <button class="edit-vencimiento-btn bg-gray-600 hover:bg-gray-500 text-white text-xs px-2.5 py-1 rounded-md">Editar</button>
                        <button class="delete-vencimiento-btn bg-red-800 hover:bg-red-700 text-white text-xs px-2.5 py-1 rounded-md">Borrar</button>
                    </div>
                </td>
            `;
            vencimientoListBody.appendChild(tr);
        });
    }

    // ---------- L√ìGICA DE CASOS (CRUD, B√öSQUEDA, ORDEN) ----------
    addCaseBtn.addEventListener("click", () => {
      caseMode = "create";
      caseForm.reset();
      document.getElementById('case-id').value = '';
      clearAllErrors(caseForm);
      caseModalTitle.textContent = "Agregar Nuevo Caso";
      document.getElementById("case-fuero-otro").classList.add("hidden");
      openModal(caseModal);
    });
    xCaseBtn.addEventListener("click", () => closeModal(caseModal));
    cancelCaseBtn.addEventListener("click", () => closeModal(caseModal));

    document.getElementById("case-fuero").addEventListener("change", (e) => {
      const other = document.getElementById("case-fuero-otro");
      e.target.value === "Otro" ? other.classList.remove("hidden") : other.classList.add("hidden");
    });

    caseForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAllErrors(caseForm);
      const id = document.getElementById('case-id').value;
      const expedienteInput = document.getElementById("case-expediente");
      const expediente = expedienteInput.value.trim();
      
      let hasError = false;
      if (!document.getElementById("case-actorNombre").value.trim()) { showFieldError(document.getElementById("case-actorNombre"), "Ingrese el nombre del actor."); hasError = true; }
      if (!document.getElementById("case-demandadoNombre").value.trim()) { showFieldError(document.getElementById("case-demandadoNombre"), "Ingrese el nombre del demandado."); hasError = true; }
      if (!expediente) { showFieldError(expedienteInput, "Ingrese el n√∫mero de expediente."); hasError = true; }
      if (!document.getElementById("case-fuero").value) { showFieldError(document.getElementById("case-fuero"), "Seleccione un fuero."); hasError = true; }
      if (document.getElementById("case-fuero").value === "Otro" && !document.getElementById("case-fuero-otro").value.trim()) { showFieldError(document.getElementById("case-fuero-otro"), "Especifique el fuero."); hasError = true; }
      if (!document.getElementById("case-juzgado").value.trim()) { showFieldError(document.getElementById("case-juzgado"), "Ingrese la nominaci√≥n."); hasError = true; }

      if (expediente && casos.some(c => c.expediente.toLowerCase() === expediente.toLowerCase() && c.id !== id)) {
        showFieldError(expedienteInput, "Ya existe un expediente con ese n√∫mero.");
        hasError = true;
      }
      if (hasError) { showToast("Corrija los errores.", "warn"); return; }
      
      const fueroSel = document.getElementById("case-fuero").value;
      const fueroOtro = document.getElementById("case-fuero-otro").value.trim();
      const fuero = fueroSel === "Otro" ? fueroOtro : fueroSel;

      const casoData = {
        actorNombre: document.getElementById("case-actorNombre").value.trim(),
        demandadoNombre: document.getElementById("case-demandadoNombre").value.trim(),
        expediente,
        objeto: document.getElementById("case-objeto").value.trim(),
        fuero,
        juzgado: document.getElementById("case-juzgado").value.trim(),
        provincia: document.getElementById("case-provincia").value.trim(),
        abogado: document.getElementById("case-abogado").value.trim(),
        telefono: document.getElementById("case-telefono").value.trim(),
      };

      try {
        if (caseMode === 'edit') {
            const caseRef = doc(db, `users/${currentUserId}/casos`, id);
            await updateDoc(caseRef, casoData);
            showToast("Caso actualizado con √©xito ‚úÖ", "success");
        } else {
            await addDoc(collection(db, `users/${currentUserId}/casos`), {...casoData, movimientos: [], pruebas: []});
            showToast("Caso creado con √©xito ‚úÖ", "success");
        }
        closeModal(caseModal);
      } catch (error) {
          console.error("Error saving case: ", error);
          showToast("Error al guardar el caso.", "error");
      }
    });

    caseListBody.addEventListener("click", async (e) => {
      const target = e.target;
      const caseId = target.closest("tr").dataset.id;
      if(!caseId) return;
      
      const caso = casos.find(c => c.id === caseId);
      if(!caso) return;
      
      if (target.classList.contains("view-btn")) {
        currentCaseId = caseId;
        detailsContent.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
            <div><strong>Actor:</strong><div class="mt-1">${caso.actorNombre || 'N/A'}</div></div>
            <div><strong>Demandado:</strong><div class="mt-1">${caso.demandadoNombre || 'N/A'}</div></div>
            <div><strong>N¬∞ Expediente:</strong><div class="mt-1">${caso.expediente}</div></div>
            <div><strong>Objeto del juicio:</strong><div class="mt-1">${caso.objeto || "‚Äî"}</div></div>
            <div><strong>Fuero:</strong><div class="mt-1">${caso.fuero}</div></div>
            <div><strong>Nominaci√≥n:</strong><div class="mt-1">${caso.juzgado}</div></div>
            <div><strong>Provincia/Ciudad:</strong><div class="mt-1">${caso.provincia || "‚Äî"}</div></div>
            <div><strong>Abogado otra parte:</strong><div class="mt-1">${caso.abogado || "‚Äî"}</div></div>
            <div class="md:col-span-2"><strong>Tel√©fono del abogado:</strong><div class="mt-1">${caso.telefono || "‚Äî"}</div></div>
          </div>
        `;
        renderMovements(caso.movimientos, movementList);
        renderPruebas(caseId);
        renderFacturacionForCaso(caseId);
        openModal(detailsModal);
      } else if (target.classList.contains("edit-case-btn")) {
          caseMode = 'edit';
          caseForm.reset();
          clearAllErrors(caseForm);
          caseModalTitle.textContent = "Editar Caso";
          
          document.getElementById('case-id').value = caso.id;
          document.getElementById('case-actorNombre').value = caso.actorNombre;
          document.getElementById('case-demandadoNombre').value = caso.demandadoNombre;
          document.getElementById('case-expediente').value = caso.expediente;
          document.getElementById('case-objeto').value = caso.objeto;
          document.getElementById('case-fuero').value = caso.fuero;
          document.getElementById('case-juzgado').value = caso.juzgado;
          document.getElementById('case-provincia').value = caso.provincia;
          document.getElementById('case-abogado').value = caso.abogado;
          document.getElementById('case-telefono').value = caso.telefono;
          
          openModal(caseModal);
      } else if (target.classList.contains("delete-case-btn")) {
          if (confirm('¬øEst√° seguro de que desea eliminar este caso? Se borrar√°n todos sus movimientos y pruebas.')) {
              try {
                await deleteDoc(doc(db, `users/${currentUserId}/casos`, caseId));
                // Tambi√©n se deber√≠an borrar los vencimientos y facturas asociados
                showToast('Caso eliminado üóëÔ∏è', 'success');
              } catch (error) {
                console.error("Error deleting case: ", error);
                showToast("Error al eliminar el caso.", "error");
              }
          }
      }
    });
    closeDetailsBtn.addEventListener("click", () => closeModal(detailsModal));
    
    searchCasosInput.addEventListener('input', (e) => {
        searchQuery = e.target.value;
        updateCasesView();
    });

    casosThead.addEventListener('click', (e) => {
        const header = e.target.closest('.sortable-header');
        if (!header) return;
        const sortKey = header.dataset.sort;
        if (sortConfig.key === sortKey) {
            sortConfig.direction = sortConfig.direction === 'ascending' ? 'descending' : 'ascending';
        } else {
            sortConfig.key = sortKey;
            sortConfig.direction = 'ascending';
        }
        updateCasesView();
    });

    // ---------- L√ìGICA DE MOVIMIENTOS (General) ----------
    function initializeQuillEditor(data) {
        const editorContainer = document.getElementById('mov-detalle-editor');
        editorContainer.innerHTML = '';
        quillEditor = new Quill(editorContainer, {
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                ]
            },
            theme: 'snow'
        });
        quillEditor.root.innerHTML = data.detalle || '';
    }

    function openMovementModalForContext(mode, context, data = {}, index = null) {
        movementMode = mode;
        movementContext = context;
        currentMovementIndex = index;
        movementForm.reset();
        clearAllErrors(movementForm);
        
        document.getElementById("mov-fecha").value = data.fecha || new Date().toISOString().slice(0, 10);
        document.getElementById("mov-tipo").value = data.tipo || "";
        document.getElementById("mov-descripcion").value = data.descripcion || "";
        
        initializeQuillEditor(data);
        
        keptFiles = data.archivos ? [...data.archivos] : [];
        newFiles = [];
        renderFilePreview();
        
        const titleAction = mode === 'edit' ? 'Editar' : 'Agregar';
        const titleContext = context === 'prueba' ? 'en Cuaderno de Prueba' : 'en Expediente Principal';
        movementModalTitle.textContent = `${titleAction} Movimiento ${titleContext}`;
        
        openModal(movementModal);
    }

    addMovementBtn.addEventListener('click', () => openMovementModalForContext('create', 'main'));
    addPruebaMovementBtn.addEventListener('click', () => openMovementModalForContext('create', 'prueba'));

    movementForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearAllErrors(movementForm);
      let hasErr = false;
      if (!document.getElementById("mov-fecha").value) { showFieldError(document.getElementById("mov-fecha"), "Ingrese la fecha."); hasErr = true; }
      if (!document.getElementById("mov-tipo").value) { showFieldError(document.getElementById("mov-tipo"), "Seleccione el tipo."); hasErr = true; }
      if (!document.getElementById("mov-descripcion").value.trim()) { showFieldError(document.getElementById("mov-descripcion"), "Ingrese una descripci√≥n."); hasErr = true; }
      if (hasErr) { showToast("Corrija los errores.", "warn"); return; }
      
      const saveBtn = document.getElementById('save-movement-btn');
      const btnText = saveBtn.querySelector('.btn-text');
      const loader = saveBtn.querySelector('.loader');

      btnText.classList.add('hidden');
      loader.classList.remove('hidden');
      saveBtn.disabled = true;

      try {
        const uploadPromises = newFiles.map(fileObj => {
            const filePath = `users/${currentUserId}/casos/${currentCaseId}/${Date.now()}_${fileObj.file.name}`;
            const fileRef = ref(storage, filePath);
            return uploadBytes(fileRef, fileObj.file).then(snapshot => getDownloadURL(snapshot.ref));
        });

        const uploadedUrls = await Promise.all(uploadPromises);
        const newFileObjects = uploadedUrls.map((url, index) => ({
            nombre: newFiles[index].file.name,
            url: url,
            path: `users/${currentUserId}/casos/${currentCaseId}/${Date.now()}_${newFiles[index].file.name}`
        }));

        const archivosFinal = [...keptFiles, ...newFileObjects];
        
        const entry = {
            fecha: document.getElementById("mov-fecha").value,
            tipo: document.getElementById("mov-tipo").value,
            descripcion: document.getElementById("mov-descripcion").value.trim(),
            detalle: quillEditor.root.innerHTML,
            archivos: archivosFinal,
        };

        const caso = casos.find(c => c.id === currentCaseId);
        if (!caso) throw new Error("Caso no encontrado");
        
        let targetMovements;
        if (movementContext === 'prueba') {
            const prueba = caso.pruebas.find(p => p.id === currentPruebaId);
            targetMovements = prueba.movimientos;
        } else {
            targetMovements = caso.movimientos;
        }

        if (movementMode === "edit" && currentMovementIndex !== null) {
            targetMovements[currentMovementIndex] = entry;
        } else {
            targetMovements.push(entry);
        }
        
        const caseRef = doc(db, `users/${currentUserId}/casos`, currentCaseId);
        await updateDoc(caseRef, { movimientos: caso.movimientos, pruebas: caso.pruebas });
        
        showToast("Movimiento guardado ‚úÖ", "success");
        closeModal(movementModal);

      } catch (error) {
        console.error("Error saving movement: ", error);
        showToast("Error al guardar el movimiento.", "error");
      } finally {
        btnText.classList.remove('hidden');
        loader.classList.add('hidden');
        saveBtn.disabled = false;
      }
    });
    
    xMovementBtn.addEventListener("click", () => closeModal(movementModal));
    cancelMovementBtn.addEventListener("click", () => closeModal(movementModal));

    movArchivosInput.addEventListener("change", (e) => {
      Array.from(e.target.files || []).forEach(f => {
        newFiles.push({ id: 'nf_' + Date.now() + Math.random(), file: f });
      });
      renderFilePreview();
      movArchivosInput.value = "";
    });

    function renderFilePreview() {
      filePreview.innerHTML = "";
      [...keptFiles, ...newFiles].forEach((f, idx) => {
        const isKept = !!f.url;
        const fileName = isKept ? f.nombre : f.file.name;
        const div = document.createElement('div');
        div.className = 'file-pill';
        div.innerHTML = `<span class="file-link">${fileName}</span> <button data-idx="${idx}">‚úñ</button>`;
        div.querySelector('button').addEventListener('click', () => {
          if (isKept) {
             if (confirm('¬øQuitar este archivo guardado del movimiento?')) keptFiles.splice(idx, 1);
          } else {
             newFiles.splice(idx - keptFiles.length, 1);
          }
          renderFilePreview();
        });
        filePreview.appendChild(div);
      });
      if (keptFiles.length === 0 && newFiles.length === 0) {
        filePreview.innerHTML = "<p class='text-gray-400 text-sm'>No hay archivos seleccionados.</p>";
      }
    }

    function openViewMovementModal(context, index) {
        movementContext = context;
        currentMovementIndex = index;
        
        const caso = casos.find(c => c.id === currentCaseId);
        if (!caso) return;

        let movement;
        if (context === 'prueba') {
            const prueba = caso.pruebas.find(p => p.id === currentPruebaId);
            movement = prueba.movimientos[index];
        } else {
            movement = caso.movimientos[index];
        }

        if (!movement) return;

        let fileBlock = "";
        if (movement.archivos && movement.archivos.length > 0) {
            fileBlock = `<div><strong class="block mb-2">Archivos Adjuntos:</strong><div class="flex flex-wrap gap-2">${movement.archivos.map(f => `<a href="${f.url}" target="_blank" class="file-link bg-gray-700 px-2 py-1 rounded">${f.nombre}</a>`).join('')}</div></div>`;
        }

        viewMovementContent.innerHTML = `
            <p><strong>Fecha:</strong> ${movement.fecha}</p>
            <p><strong>Tipo:</strong> ${movement.tipo}</p>
            <p><strong>Descripci√≥n:</strong> ${movement.descripcion}</p>
            <div class="mt-4 pt-4 border-t border-gray-600">
                <p class="mb-2"><strong>Detalle / Cuerpo del Escrito:</strong></p>
                <div class="formatted-content bg-gray-900/50 p-3 rounded-lg border border-gray-700">${movement.detalle || "‚Äî"}</div>
            </div>
            <div class="mt-4">${fileBlock}</div>
        `;
        openModal(viewMovementModal);
    }

    movementList.addEventListener('click', e => {
        const li = e.target.closest('li[data-index]');
        if (li) openViewMovementModal('main', Number(li.dataset.index));
    });
    pruebaMovementList.addEventListener('click', e => {
        const li = e.target.closest('li[data-index]');
        if (li) openViewMovementModal('prueba', Number(li.dataset.index));
    });

    closeViewMovementBtn.addEventListener('click', () => closeModal(viewMovementModal));

    editMovFromViewBtn.addEventListener('click', () => {
        const caso = casos.find(c => c.id === currentCaseId);
        let movement;
        if (movementContext === 'prueba') {
            const prueba = caso.pruebas.find(p => p.id === currentPruebaId);
            movement = prueba.movimientos[currentMovementIndex];
        } else {
            movement = caso.movimientos[currentMovementIndex];
        }
        closeModal(viewMovementModal);
        openMovementModalForContext('edit', movementContext, movement, currentMovementIndex);
    });

    deleteMovFromViewBtn.addEventListener('click', async () => {
        if (!confirm('¬øEst√° seguro de que desea eliminar este movimiento?')) return;
        
        const caso = casos.find(c => c.id === currentCaseId);
        if(!caso) return;

        let movementToDelete;
        if (movementContext === 'prueba') {
            const prueba = caso.pruebas.find(p => p.id === currentPruebaId);
            movementToDelete = prueba.movimientos.splice(currentMovementIndex, 1)[0];
        } else {
            movementToDelete = caso.movimientos.splice(currentMovementIndex, 1)[0];
        }
        
        try {
            // Eliminar archivos de Storage
            if (movementToDelete.archivos && movementToDelete.archivos.length > 0) {
                const deletePromises = movementToDelete.archivos.map(file => {
                    const fileRef = ref(storage, file.path);
                    return deleteObject(fileRef);
                });
                await Promise.all(deletePromises);
            }

            const caseRef = doc(db, `users/${currentUserId}/casos`, currentCaseId);
            await updateDoc(caseRef, { movimientos: caso.movimientos, pruebas: caso.pruebas });
            closeModal(viewMovementModal);
            showToast('Movimiento eliminado üóëÔ∏è', 'success');
        } catch(error) {
            console.error("Error deleting movement: ", error);
            showToast("Error al eliminar el movimiento.", "error");
        }
    });

    exportDocxBtn.addEventListener('click', async () => {
        const caso = casos.find(c => c.id === currentCaseId);
        let movement;
        if (movementContext === 'prueba') {
            const prueba = caso.pruebas.find(p => p.id === currentPruebaId);
            movement = prueba.movimientos[currentMovementIndex];
        } else {
            movement = caso.movimientos[currentMovementIndex];
        }

        const content = `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${movement.detalle}</body></html>`;
        
        try {
            const fileBuffer = await htmlToDocx.asBlob(content);
            const fileName = `Escrito_${caso.expediente.replace('/', '-')}_${movement.fecha}.docx`;
            
            const url = URL.createObjectURL(fileBuffer);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showToast('Exportado a .docx con √©xito ‚úÖ', 'success');
        } catch (error) {
            console.error('Error al exportar:', error);
            showToast('Error al exportar el documento', 'error');
        }
    });

    // ---------- L√ìGICA DE PRUEBAS ----------
    function renderPruebas(caseId) {
        const caso = casos.find(c => c.id === caseId);
        pruebaList.innerHTML = '';
        if (!caso || !caso.pruebas || caso.pruebas.length === 0) {
            pruebaList.innerHTML = `<p class="text-gray-400">No hay cuadernos de prueba registrados.</p>`;
            return;
        }
        caso.pruebas.forEach(p => {
            const div = document.createElement('div');
            div.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
            div.dataset.id = p.id;
            div.innerHTML = `
                <div>
                    <p class="font-semibold text-white">${p.titulo}</p>
                    <p class="text-sm text-gray-400">${p.tipo}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button class="manage-prueba-btn bg-blue-600 hover:bg-blue-500 text-white text-xs px-2.5 py-1 rounded-md">Gestionar</button>
                    <button class="edit-prueba-btn bg-gray-600 hover:bg-gray-500 text-white text-xs px-2.5 py-1 rounded-md">Editar</button>
                    <button class="delete-prueba-btn bg-red-800 hover:bg-red-700 text-white text-xs px-2.5 py-1 rounded-md">Borrar</button>
                </div>
            `;
            pruebaList.appendChild(div);
        });
    }

    addPruebaBtn.addEventListener('click', () => {
        pruebaMode = 'create';
        pruebaForm.reset();
        clearAllErrors(pruebaForm);
        pruebaModalTitle.textContent = 'Agregar Cuaderno de Prueba';
        currentPruebaId = null;
        openModal(pruebaFormModal);
    });

    xPruebaFormBtn.addEventListener('click', () => closeModal(pruebaFormModal));
    cancelPruebaBtn.addEventListener('click', () => closeModal(pruebaFormModal));

    pruebaForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearAllErrors(pruebaForm);
        const tipoInput = document.getElementById('prueba-tipo');
        const tituloInput = document.getElementById('prueba-titulo');
        let hasError = false;
        if (!tipoInput.value) { showFieldError(tipoInput, 'Seleccione un tipo.'); hasError = true; }
        if (!tituloInput.value.trim()) { showFieldError(tituloInput, 'Ingrese un t√≠tulo.'); hasError = true; }
        if (hasError) return;

        const caso = casos.find(c => c.id === currentCaseId);
        if (!caso) return;
        
        const pruebaData = {
            tipo: tipoInput.value,
            titulo: tituloInput.value.trim(),
        };

        if (pruebaMode === 'edit') {
            const prueba = caso.pruebas.find(p => p.id === currentPruebaId);
            if (prueba) {
                prueba.tipo = pruebaData.tipo;
                prueba.titulo = pruebaData.titulo;
            }
        } else {
            const newPrueba = {
                id: Date.now(),
                ...pruebaData,
                movimientos: []
            };
            caso.pruebas.push(newPrueba);
        }
        
        try {
            const caseRef = doc(db, `users/${currentUserId}/casos`, currentCaseId);
            await updateDoc(caseRef, { pruebas: caso.pruebas });
            showToast('Cuaderno de prueba guardado ‚úÖ', 'success');
            closeModal(pruebaFormModal);
        } catch (error) {
            console.error("Error saving prueba: ", error);
            showToast("Error al guardar la prueba.", "error");
        }
    });

    pruebaList.addEventListener('click', async e => {
        const target = e.target;
        const pruebaDiv = target.closest('div[data-id]');
        if (!pruebaDiv) return;
        const pruebaId = Number(pruebaDiv.dataset.id);
        const caso = casos.find(c => c.id === currentCaseId);
        const prueba = caso.pruebas.find(p => p.id === pruebaId);
        if (!prueba) return;

        currentPruebaId = pruebaId;

        if (target.classList.contains('manage-prueba-btn')) {
            pruebaDetailTitle.textContent = prueba.titulo;
            pruebaDetailSubtitle.textContent = `Cuaderno de Prueba ${prueba.tipo}`;
            renderMovements(prueba.movimientos, pruebaMovementList);
            openModal(pruebaDetailModal);
        } else if (target.classList.contains('edit-prueba-btn')) {
            pruebaMode = 'edit';
            pruebaForm.reset();
            clearAllErrors(pruebaForm);
            pruebaModalTitle.textContent = 'Editar Cuaderno de Prueba';
            document.getElementById('prueba-tipo').value = prueba.tipo;
            document.getElementById('prueba-titulo').value = prueba.titulo;
            openModal(pruebaFormModal);
        } else if (target.classList.contains('delete-prueba-btn')) {
            if (confirm('¬øEliminar este cuaderno de prueba y todos sus movimientos?')) {
                caso.pruebas = caso.pruebas.filter(p => p.id !== pruebaId);
                try {
                    const caseRef = doc(db, `users/${currentUserId}/casos`, currentCaseId);
                    await updateDoc(caseRef, { pruebas: caso.pruebas });
                    showToast('Cuaderno de prueba eliminado üóëÔ∏è', 'success');
                } catch(error) {
                    console.error("Error deleting prueba: ", error);
                    showToast("Error al eliminar la prueba.", "error");
                }
            }
        }
    });
    
    closePruebaDetailBtn.addEventListener('click', () => closeModal(pruebaDetailModal));

    // ---------- L√ìGICA DE VENCIMIENTOS ----------
    function populateCasosSelect(selectElement, selectedId = null) {
        selectElement.innerHTML = '<option value="">Ninguno</option>';
        casos.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = `${c.expediente} (${c.actorNombre} vs ${c.demandadoNombre})`;
            if (selectedId && c.id === selectedId) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
    }

    addVencimientoBtn.addEventListener("click", () => {
        vencimientoMode = "create";
        vencimientoForm.reset();
        document.getElementById('vencimiento-id').value = '';
        clearAllErrors(vencimientoForm);
        vencimientoModalTitle.textContent = "Agregar Vencimiento";
        populateCasosSelect(vencimientoCasoIdSelect);
        openModal(vencimientoModal);
        setTimeout(() => document.getElementById("vencimiento-titulo").focus(), 200);
    });

    xVencimientoBtn.addEventListener("click", () => closeModal(vencimientoModal));
    cancelVencimientoBtn.addEventListener("click", () => closeModal(vencimientoModal));

    vencimientoForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearAllErrors(vencimientoForm);
        let hasError = false;
        if (!document.getElementById("vencimiento-titulo").value.trim()) { showFieldError(document.getElementById("vencimiento-titulo"), "Ingrese un t√≠tulo."); hasError = true; }
        if (!document.getElementById("vencimiento-fecha").value) { showFieldError(document.getElementById("vencimiento-fecha"), "Ingrese una fecha."); hasError = true; }
        if (!document.getElementById("vencimiento-recordatorio").value) { showFieldError(document.getElementById("vencimiento-recordatorio"), "Seleccione un recordatorio."); hasError = true; }
        if (hasError) { showToast("Corrija los errores.", "warn"); return; }
        
        const id = document.getElementById('vencimiento-id').value;
        const vencimientoData = {
            titulo: document.getElementById("vencimiento-titulo").value.trim(),
            fecha: document.getElementById("vencimiento-fecha").value,
            casoId: document.getElementById("vencimiento-caso-id").value || null,
            recordatorio: Number(document.getElementById("vencimiento-recordatorio").value),
        };

        try {
            if (vencimientoMode === 'edit') {
                await updateDoc(doc(db, `users/${currentUserId}/vencimientos`, id), vencimientoData);
                showToast("Vencimiento actualizado ‚úÖ", "success");
            } else {
                await addDoc(collection(db, `users/${currentUserId}/vencimientos`), vencimientoData);
                showToast("Vencimiento agregado ‚úÖ", "success");
            }
            closeModal(vencimientoModal);
        } catch(error) {
            console.error("Error saving vencimiento: ", error);
            showToast("Error al guardar el vencimiento.", "error");
        }
    });

    vencimientoListBody.addEventListener('click', async (e) => {
        const target = e.target;
        const id = target.closest('tr').dataset.id;
        if(!id) return;

        if (target.classList.contains('edit-vencimiento-btn')) {
            const vencimiento = vencimientos.find(v => v.id === id);
            if (!vencimiento) return;
            vencimientoMode = 'edit';
            vencimientoForm.reset();
            clearAllErrors(vencimientoForm);
            vencimientoModalTitle.textContent = "Editar Vencimiento";

            document.getElementById('vencimiento-id').value = vencimiento.id;
            document.getElementById('vencimiento-titulo').value = vencimiento.titulo;
            document.getElementById('vencimiento-fecha').value = vencimiento.fecha;
            document.getElementById('vencimiento-recordatorio').value = vencimiento.recordatorio;
            populateCasosSelect(vencimientoCasoIdSelect, vencimiento.casoId);
            openModal(vencimientoModal);
        }

        if (target.classList.contains('delete-vencimiento-btn')) {
            if (confirm('¬øEst√° seguro de que desea eliminar este vencimiento?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUserId}/vencimientos`, id));
                    showToast('Vencimiento eliminado üóëÔ∏è', 'success');
                } catch(error) {
                    console.error("Error deleting vencimiento: ", error);
                    showToast("Error al eliminar el vencimiento.", "error");
                }
            }
        }
    });

    // ---------- L√ìGICA DE FACTURACI√ìN ----------
    const formatCurrency = (amount) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount);

    function renderFacturacion() {
        facturacionListBody.innerHTML = '';
        let totalFacturado = 0, totalCobrado = 0;

        facturacion.forEach(item => {
            const caso = item.casoId ? casos.find(c => c.id === item.casoId) : null;
            const tr = document.createElement('tr');
            tr.className = "border-b border-gray-700 hover-row";
            tr.dataset.id = item.id;
            const estadoClass = item.estado === 'Pagado' ? 'text-green-400' : 'text-yellow-400';
            tr.innerHTML = `
                <td class="px-6 py-4">${item.concepto}</td>
                <td class="px-6 py-4">${caso ? caso.expediente : 'Sin vincular'}</td>
                <td class="px-6 py-4">${item.fecha}</td>
                <td class="px-6 py-4">${formatCurrency(item.monto)}</td>
                <td class="px-6 py-4 font-semibold ${estadoClass}">${item.estado}</td>
                <td class="px-6 py-4 text-right">
                    <div class="flex justify-end items-center space-x-2">
                        <button class="edit-facturacion-btn bg-gray-600 hover:bg-gray-500 text-white text-xs px-2.5 py-1 rounded-md">Editar</button>
                        <button class="delete-facturacion-btn bg-red-800 hover:bg-red-700 text-white text-xs px-2.5 py-1 rounded-md">Borrar</button>
                    </div>
                </td>
            `;
            facturacionListBody.appendChild(tr);

            totalFacturado += item.monto;
            if (item.estado === 'Pagado') {
                totalCobrado += item.monto;
            }
        });
        document.getElementById('total-facturado').textContent = formatCurrency(totalFacturado);
        document.getElementById('total-cobrado').textContent = formatCurrency(totalCobrado);
        document.getElementById('total-pendiente').textContent = formatCurrency(totalFacturado - totalCobrado);
    }

    function renderFacturacionForCaso(caseId) {
        const items = facturacion.filter(f => f.casoId === caseId);
        caseFacturacionList.innerHTML = '';
        if (items.length === 0) {
            caseFacturacionList.innerHTML = '<p class="text-gray-400">No hay items de facturaci√≥n para este caso.</p>';
            return;
        }
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center text-sm';
            const estadoClass = item.estado === 'Pagado' ? 'text-green-400' : 'text-yellow-400';
            div.innerHTML = `
                <div>
                    <p class="font-semibold text-white">${item.concepto} <span class="text-xs text-gray-400">(${item.fecha})</span></p>
                    <p class="${estadoClass}">${item.tipo} - ${formatCurrency(item.monto)}</p>
                </div>
            `;
            caseFacturacionList.appendChild(div);
        });
    }

    addFacturacionBtn.addEventListener('click', () => openFacturacionModal('create'));
    addFacturacionFromCaseBtn.addEventListener('click', () => openFacturacionModal('create', { casoId: currentCaseId }));

    function openFacturacionModal(mode, data = {}) {
        facturacionMode = mode;
        facturacionForm.reset();
        clearAllErrors(facturacionForm);
        facturacionModalTitle.textContent = mode === 'edit' ? 'Editar Item' : 'Agregar Item';
        
        document.getElementById('facturacion-id').value = data.id || '';
        document.getElementById('facturacion-concepto').value = data.concepto || '';
        document.getElementById('facturacion-fecha').value = data.fecha || new Date().toISOString().slice(0, 10);
        document.getElementById('facturacion-monto').value = data.monto || '';
        document.getElementById('facturacion-tipo').value = data.tipo || 'Honorarios';
        document.getElementById('facturacion-estado').value = data.estado || 'Pendiente';
        
        const selectorDiv = document.getElementById('facturacion-caso-selector-div');
        if (data.casoId) {
            selectorDiv.classList.add('hidden');
        } else {
            selectorDiv.classList.remove('hidden');
            populateCasosSelect(document.getElementById('facturacion-caso-id'), data.casoId);
        }

        openModal(facturacionModal);
    }

    xFacturacionBtn.addEventListener('click', () => closeModal(facturacionModal));
    cancelFacturacionBtn.addEventListener('click', () => closeModal(facturacionModal));

    facturacionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearAllErrors(facturacionForm);
        let hasError = false;
        if (!document.getElementById('facturacion-concepto').value.trim()) { showFieldError(document.getElementById('facturacion-concepto'), 'Ingrese un concepto.'); hasError = true; }
        if (!document.getElementById('facturacion-fecha').value) { showFieldError(document.getElementById('facturacion-fecha'), 'Ingrese una fecha.'); hasError = true; }
        if (!document.getElementById('facturacion-monto').value) { showFieldError(document.getElementById('facturacion-monto'), 'Ingrese un monto.'); hasError = true; }
        if (hasError) return;

        const id = document.getElementById('facturacion-id').value;
        const selectorDiv = document.getElementById('facturacion-caso-selector-div');
        
        const itemData = {
            concepto: document.getElementById('facturacion-concepto').value.trim(),
            fecha: document.getElementById('facturacion-fecha').value,
            monto: parseFloat(document.getElementById('facturacion-monto').value),
            tipo: document.getElementById('facturacion-tipo').value,
            estado: document.getElementById('facturacion-estado').value,
            casoId: selectorDiv.classList.contains('hidden') ? currentCaseId : (document.getElementById('facturacion-caso-id').value || null)
        };
        
        try {
            if (facturacionMode === 'edit') {
                await updateDoc(doc(db, `users/${currentUserId}/facturacion`, id), itemData);
                showToast('Item actualizado ‚úÖ');
            } else {
                await addDoc(collection(db, `users/${currentUserId}/facturacion`), itemData);
                showToast('Item agregado ‚úÖ');
            }
            closeModal(facturacionModal);
        } catch(error) {
            console.error("Error saving facturacion: ", error);
            showToast("Error al guardar la facturaci√≥n.", "error");
        }
    });

    facturacionListBody.addEventListener('click', async e => {
        const target = e.target;
        const id = target.closest('tr').dataset.id;
        if (!id) return;
        const item = facturacion.find(f => f.id === id);
        if (!item) return;

        if (target.classList.contains('edit-facturacion-btn')) {
            openFacturacionModal('edit', item);
        } else if (target.classList.contains('delete-facturacion-btn')) {
            if (confirm('¬øEliminar este item de facturaci√≥n?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUserId}/facturacion`, id));
                    showToast('Item eliminado üóëÔ∏è');
                } catch(error) {
                    console.error("Error deleting facturacion: ", error);
                    showToast("Error al eliminar la facturaci√≥n.", "error");
                }
            }
        }
    });
    
    generateReportBtn.addEventListener('click', async () => {
        const caso = casos.find(c => c.id === currentCaseId);
        if (!caso) return;
        const items = facturacion.filter(f => f.casoId === currentCaseId);
        
        let total = 0;
        const rows = items.map(item => {
            total += item.monto;
            return `<tr><td style="border: 1px solid #ddd; padding: 8px;">${item.fecha}</td><td style="border: 1px solid #ddd; padding: 8px;">${item.concepto} (${item.tipo})</td><td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatCurrency(item.monto)}</td></tr>`;
        }).join('');

        const htmlContent = `
            <h1>Informe de Gastos y Honorarios</h1>
            <p><strong>Expediente:</strong> ${caso.expediente}</p>
            <p><strong>Car√°tula:</strong> ${caso.actorNombre} vs. ${caso.demandadoNombre}</p>
            <hr>
            <table style="width: 100%; border-collapse: collapse;">
                <thead><tr><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Fecha</th><th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Concepto</th><th style="border: 1px solid #ddd; padding: 8px; text-align: right;">Monto</th></tr></thead>
                <tbody>${rows}</tbody>
                <tfoot><tr><td colspan="2" style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">TOTAL</td><td style="border: 1px solid #ddd; padding: 8px; text-align: right; font-weight: bold;">${formatCurrency(total)}</td></tr></tfoot>
            </table>
        `;
        
        const fileBuffer = await htmlToDocx.asBlob(`<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${htmlContent}</body></html>`);
        const fileName = `Informe_Facturacion_${caso.expediente.replace('/', '-')}.docx`;
        const url = URL.createObjectURL(fileBuffer);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        showToast('Informe generado ‚úÖ', 'success');
    });

    // ---------- L√ìGICA DE CONTACTOS ----------
    function renderContactos() {
        contactoListBody.innerHTML = '';
        contactos.forEach(c => {
            const tr = document.createElement('tr');
            tr.className = "border-b border-gray-700 hover-row";
            tr.dataset.id = c.id;
            tr.innerHTML = `
                <td class="px-6 py-4">${c.nombre}</td>
                <td class="px-6 py-4">${c.telefono || '‚Äî'}</td>
                <td class="px-6 py-4">${c.email || '‚Äî'}</td>
                <td class="px-6 py-4">${c.dni || '‚Äî'}</td>
                <td class="px-6 py-4 text-right">
                    <div class="flex justify-end items-center space-x-2">
                        <button class="edit-contacto-btn bg-gray-600 hover:bg-gray-500 text-white text-xs px-2.5 py-1 rounded-md">Editar</button>
                        <button class="delete-contacto-btn bg-red-800 hover:bg-red-700 text-white text-xs px-2.5 py-1 rounded-md">Borrar</button>
                    </div>
                </td>
            `;
            contactoListBody.appendChild(tr);
        });
    }

    addContactoBtn.addEventListener('click', () => {
        contactoMode = 'create';
        contactoForm.reset();
        clearAllErrors(contactoForm);
        contactoModalTitle.textContent = 'Agregar Contacto';
        document.getElementById('contacto-id').value = '';
        openModal(contactoModal);
    });

    xContactoBtn.addEventListener('click', () => closeModal(contactoModal));
    cancelContactoBtn.addEventListener('click', () => closeModal(contactoModal));

    contactoForm.addEventListener('submit', async e => {
        e.preventDefault();
        clearAllErrors(contactoForm);
        const nombreInput = document.getElementById('contacto-nombre');
        if (!nombreInput.value.trim()) {
            showFieldError(nombreInput, 'El nombre es obligatorio.');
            return;
        }

        const id = document.getElementById('contacto-id').value;
        const contactoData = {
            nombre: nombreInput.value.trim(),
            telefono: document.getElementById('contacto-telefono').value.trim(),
            email: document.getElementById('contacto-email').value.trim(),
            dni: document.getElementById('contacto-dni').value.trim(),
            domicilio: document.getElementById('contacto-domicilio').value.trim(),
            notas: document.getElementById('contacto-notas').value.trim(),
        };

        try {
            if (contactoMode === 'edit') {
                await updateDoc(doc(db, `users/${currentUserId}/contactos`, id), contactoData);
                showToast('Contacto actualizado ‚úÖ');
            } else {
                await addDoc(collection(db, `users/${currentUserId}/contactos`), contactoData);
                showToast('Contacto agregado ‚úÖ');
            }
            closeModal(contactoModal);
        } catch(error) {
            console.error("Error saving contacto: ", error);
            showToast("Error al guardar el contacto.", "error");
        }
    });

    contactoListBody.addEventListener('click', async e => {
        const target = e.target;
        const id = target.closest('tr').dataset.id;
        if (!id) return;
        const contacto = contactos.find(c => c.id === id);
        if (!contacto) return;

        if (target.classList.contains('edit-contacto-btn')) {
            contactoMode = 'edit';
            contactoForm.reset();
            clearAllErrors(contactoForm);
            contactoModalTitle.textContent = 'Editar Contacto';
            document.getElementById('contacto-id').value = contacto.id;
            document.getElementById('contacto-nombre').value = contacto.nombre;
            document.getElementById('contacto-telefono').value = contacto.telefono;
            document.getElementById('contacto-email').value = contacto.email;
            document.getElementById('contacto-dni').value = contacto.dni;
            document.getElementById('contacto-domicilio').value = contacto.domicilio;
            document.getElementById('contacto-notas').value = contacto.notas;
            openModal(contactoModal);
        } else if (target.classList.contains('delete-contacto-btn')) {
            if (confirm('¬øEliminar este contacto? No se podr√° vincular a nuevos casos.')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUserId}/contactos`, id));
                    showToast('Contacto eliminado üóëÔ∏è');
                } catch(error) {
                    console.error("Error deleting contacto: ", error);
                    showToast("Error al eliminar el contacto.", "error");
                }
            }
        }
    });

    // ---------- L√ìGICA DE TAREAS ----------
    function renderTareas() {
        tareaListBody.innerHTML = '';
        tareas.sort((a,b) => (a.estado === 'Completada' ? 1 : -1) || new Date(a.fechaLimite) - new Date(b.fechaLimite));
        
        tareas.forEach(t => {
            const caso = t.casoId ? casos.find(c => c.id === t.casoId) : null;
            const tr = document.createElement('tr');
            tr.className = "border-b border-gray-700 hover-row";
            tr.dataset.id = t.id;
            const isCompleted = t.estado === 'Completada';
            tr.innerHTML = `
                <td class="px-6 py-4"><input type="checkbox" class="toggle-task-status w-5 h-5" ${isCompleted ? 'checked' : ''}></td>
                <td class="px-6 py-4 ${isCompleted ? 'task-completed' : ''}">${t.descripcion}</td>
                <td class="px-6 py-4">${caso ? caso.expediente : '‚Äî'}</td>
                <td class="px-6 py-4">${t.fechaLimite || '‚Äî'}</td>
                <td class="px-6 py-4 text-right">
                    <div class="flex justify-end items-center space-x-2">
                        <button class="edit-tarea-btn bg-gray-600 hover:bg-gray-500 text-white text-xs px-2.5 py-1 rounded-md">Editar</button>
                        <button class="delete-tarea-btn bg-red-800 hover:bg-red-700 text-white text-xs px-2.5 py-1 rounded-md">Borrar</button>
                    </div>
                </td>
            `;
            tareaListBody.appendChild(tr);
        });
    }

    addTareaBtn.addEventListener('click', () => {
        tareaMode = 'create';
        tareaForm.reset();
        clearAllErrors(tareaForm);
        tareaModalTitle.textContent = 'Agregar Tarea';
        document.getElementById('tarea-id').value = '';
        populateCasosSelect(document.getElementById('tarea-caso-id'));
        openModal(tareaModal);
    });

    xTareaBtn.addEventListener('click', () => closeModal(tareaModal));
    cancelTareaBtn.addEventListener('click', () => closeModal(tareaModal));

    tareaForm.addEventListener('submit', async e => {
        e.preventDefault();
        clearAllErrors(tareaForm);
        const descInput = document.getElementById('tarea-descripcion');
        if (!descInput.value.trim()) {
            showFieldError(descInput, 'La descripci√≥n es obligatoria.');
            return;
        }

        const id = document.getElementById('tarea-id').value;
        const tareaData = {
            descripcion: descInput.value.trim(),
            fechaLimite: document.getElementById('tarea-fecha').value || null,
            estado: document.getElementById('tarea-estado').value,
            casoId: document.getElementById('tarea-caso-id').value || null,
        };

        try {
            if (tareaMode === 'edit') {
                await updateDoc(doc(db, `users/${currentUserId}/tareas`, id), tareaData);
                showToast('Tarea actualizada ‚úÖ');
            } else {
                await addDoc(collection(db, `users/${currentUserId}/tareas`), tareaData);
                showToast('Tarea agregada ‚úÖ');
            }
            closeModal(tareaModal);
        } catch(error) {
            console.error("Error saving tarea: ", error);
            showToast("Error al guardar la tarea.", "error");
        }
    });

    tareaListBody.addEventListener('click', async e => {
        const target = e.target;
        const id = target.closest('tr').dataset.id;
        if (!id) return;
        const tarea = tareas.find(t => t.id === id);
        if (!tarea) return;

        if (target.classList.contains('toggle-task-status')) {
            try {
                const newStatus = target.checked ? 'Completada' : 'Pendiente';
                await updateDoc(doc(db, `users/${currentUserId}/tareas`, id), { estado: newStatus });
            } catch(error) {
                console.error("Error updating task status: ", error);
                showToast("Error al actualizar la tarea.", "error");
            }
        } else if (target.classList.contains('edit-tarea-btn')) {
            tareaMode = 'edit';
            tareaForm.reset();
            clearAllErrors(tareaForm);
            tareaModalTitle.textContent = 'Editar Tarea';
            document.getElementById('tarea-id').value = tarea.id;
            document.getElementById('tarea-descripcion').value = tarea.descripcion;
            document.getElementById('tarea-fecha').value = tarea.fechaLimite;
            document.getElementById('tarea-estado').value = tarea.estado;
            populateCasosSelect(document.getElementById('tarea-caso-id'), tarea.casoId);
            openModal(tareaModal);
        } else if (target.classList.contains('delete-tarea-btn')) {
            if (confirm('¬øEliminar esta tarea?')) {
                try {
                    await deleteDoc(doc(db, `users/${currentUserId}/tareas`, id));
                    showToast('Tarea eliminada üóëÔ∏è');
                } catch(error) {
                    console.error("Error deleting tarea: ", error);
                    showToast("Error al eliminar la tarea.", "error");
                }
            }
        }
    });
    
    // ---------- L√ìGICA DE PERFIL ----------
    async function renderProfile() {
        const user = auth.currentUser;
        if (!user) return;

        document.getElementById('profile-email').textContent = user.email;
        
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
            const userData = userSnap.data();
            document.getElementById('profile-nombre').value = userData.nombre || '';
            document.getElementById('profile-apellido').value = userData.apellido || '';
        }
    }

    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nombre = document.getElementById('profile-nombre').value.trim();
        const apellido = document.getElementById('profile-apellido').value.trim();
        
        try {
            const userRef = doc(db, "users", currentUserId);
            await setDoc(userRef, { nombre, apellido }, { merge: true });
            showToast('Perfil actualizado con √©xito ‚úÖ', 'success');
        } catch (error) {
            console.error("Error updating profile: ", error);
            showToast('Error al actualizar el perfil.', 'error');
        }
    });

    passwordChangeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newPassword = document.getElementById('profile-new-password').value;
        const confirmPassword = document.getElementById('profile-confirm-password').value;

        if (newPassword.length < 6) {
            showToast('La contrase√±a debe tener al menos 6 caracteres.', 'warn');
            return;
        }

        if (newPassword !== confirmPassword) {
            showToast('Las contrase√±as no coinciden.', 'warn');
            return;
        }

        const user = auth.currentUser;
        updatePassword(user, newPassword).then(() => {
            showToast('Contrase√±a actualizada con √©xito ‚úÖ', 'success');
            passwordChangeForm.reset();
        }).catch((error) => {
            console.error("Error updating password: ", error);
            showToast('Error al cambiar la contrase√±a. Puede que necesites volver a iniciar sesi√≥n.', 'error');
        });
    });

    // ---------- L√ìGICA DEL DASHBOARD (RESTAURADA) ----------
    function renderDashboard() {
        const dashboardVencimientos = document.getElementById('dashboard-vencimientos');
        dashboardVencimientos.innerHTML = '';
        const today = new Date();
        const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
        const upcomingVencimientos = vencimientos.filter(v => {
            const vDate = new Date(v.fecha + 'T00:00:00');
            return vDate >= today && vDate <= nextWeek;
        }).sort((a,b) => new Date(a.fecha) - new Date(b.fecha));

        if (upcomingVencimientos.length > 0) {
            upcomingVencimientos.forEach(v => {
                const caso = v.casoId ? casos.find(c => c.id === v.casoId) : null;
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-3 rounded-lg text-sm';
                div.innerHTML = `
                    <p class="font-semibold text-white">${v.titulo}</p>
                    <p class="text-gray-400">Fecha: ${v.fecha}${caso ? ` - Caso: ${caso.expediente}` : ''}</p>
                `;
                dashboardVencimientos.appendChild(div);
            });
        } else {
            dashboardVencimientos.innerHTML = '<p class="text-gray-400">No hay vencimientos en los pr√≥ximos 7 d√≠as.</p>';
        }

        const dashboardMovimientos = document.getElementById('dashboard-movimientos');
        dashboardMovimientos.innerHTML = '';
        const allMovements = [];
        casos.forEach(c => {
            if(c.movimientos) c.movimientos.forEach(m => allMovements.push({ ...m, casoId: c.id, context: 'main' }));
            if(c.pruebas) c.pruebas.forEach(p => {
                if(p.movimientos) p.movimientos.forEach(m => allMovements.push({ ...m, casoId: c.id, context: 'prueba', pruebaId: p.id }));
            });
        });
        const recentMovements = allMovements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 5);

        if (recentMovements.length > 0) {
            recentMovements.forEach(m => {
                const caso = casos.find(c => c.id === m.casoId);
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-3 rounded-lg text-sm cursor-pointer hover:bg-gray-700';
                div.dataset.casoId = m.casoId;
                div.innerHTML = `
                    <p class="font-semibold text-white">${m.descripcion}</p>
                    <p class="text-gray-400">Fecha: ${m.fecha} - Caso: ${caso.expediente}</p>
                `;
                div.addEventListener('click', () => {
                    switchTab('casos');
                    const viewBtn = document.querySelector(`#case-list-body tr[data-id="${m.casoId}"] .view-btn`);
                    if (viewBtn) viewBtn.click();
                });
                dashboardMovimientos.appendChild(div);
            });
        } else {
            dashboardMovimientos.innerHTML = '<p class="text-gray-400">No hay movimientos recientes.</p>';
        }
        
        const dashboardTareas = document.getElementById('dashboard-tareas');
        dashboardTareas.innerHTML = '';
        const pendingTareas = tareas
            .filter(t => t.estado === 'Pendiente')
            .sort((a,b) => new Date(a.fechaLimite) - new Date(b.fechaLimite))
            .slice(0, 5);

        if (pendingTareas.length > 0) {
            pendingTareas.forEach(t => {
                const caso = t.casoId ? casos.find(c => c.id === t.casoId) : null;
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-3 rounded-lg text-sm';
                div.innerHTML = `
                    <p class="font-semibold text-white">${t.descripcion}</p>
                    <p class="text-gray-400">L√≠mite: ${t.fechaLimite || 'Sin fecha'}${caso ? ` - Caso: ${caso.expediente}` : ''}</p>
                `;
                dashboardTareas.appendChild(div);
            });
        } else {
            dashboardTareas.innerHTML = '<p class="text-gray-400">No hay tareas pendientes.</p>';
        }
    }

    // ---------- L√ìGICA DEL CALENDARIO (RESTAURADA) ----------
    function renderCalendar() {
        calendarGrid.innerHTML = '';
        const month = calendarDate.getMonth();
        const year = calendarDate.getFullYear();
        calendarMonthYear.textContent = `${new Date(year, month).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`;

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < firstDayOfMonth; i++) {
            calendarGrid.innerHTML += `<div class="calendar-day other-month"></div>`;
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            const dayVencimientos = vencimientos.filter(v => v.fecha === dateStr);
            const dayTareas = tareas.filter(t => t.fechaLimite === dateStr);

            let indicatorsHTML = '';
            if (dayVencimientos.length > 0) {
                indicatorsHTML += `<div class="event-indicator event-vencimiento"></div>`;
            }
            if (dayTareas.length > 0) {
                indicatorsHTML += `<div class="event-indicator event-tarea"></div>`;
            }

            dayDiv.innerHTML = `
                <div class="calendar-day-header">${day}</div>
                <div class="event-indicator-container">${indicatorsHTML}</div>
            `;

            if (dayVencimientos.length > 0 || dayTareas.length > 0) {
                dayDiv.classList.add('has-events');
                dayDiv.dataset.date = dateStr;
            }
            
            calendarGrid.appendChild(dayDiv);
        }
    }
    
    function showDayEvents(dateStr) {
        const dayEventsList = document.getElementById('day-events-list');
        const dayEventsTitle = document.getElementById('day-events-title');
        dayEventsList.innerHTML = '';

        const date = new Date(dateStr + 'T00:00:00');
        dayEventsTitle.textContent = `Eventos del ${date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;

        const dayVencimientos = vencimientos.filter(v => v.fecha === dateStr);
        const dayTareas = tareas.filter(t => t.fechaLimite === dateStr);

        if (dayVencimientos.length === 0 && dayTareas.length === 0) {
            dayEventsList.innerHTML = '<p class="text-gray-400">No hay eventos para este d√≠a.</p>';
        } else {
            dayVencimientos.forEach(v => {
                const caso = v.casoId ? casos.find(c => c.id === v.casoId) : null;
                const li = document.createElement('div');
                li.className = 'bg-gray-700 p-3 rounded-lg';
                li.innerHTML = `
                    <p class="font-semibold text-white"><span class="text-blue-400">Vencimiento:</span> ${v.titulo}</p>
                    ${caso ? `<p class="text-sm text-gray-400">Caso: ${caso.expediente}</p>` : ''}
                `;
                dayEventsList.appendChild(li);
            });
            dayTareas.forEach(t => {
                const caso = t.casoId ? casos.find(c => c.id === t.casoId) : null;
                const li = document.createElement('div');
                li.className = 'bg-gray-700 p-3 rounded-lg';
                li.innerHTML = `
                    <p class="font-semibold text-white"><span class="text-amber-400">Tarea:</span> ${t.descripcion}</p>
                    ${caso ? `<p class="text-sm text-gray-400">Caso: ${caso.expediente}</p>` : ''}
                    <p class="text-sm text-gray-400">Estado: ${t.estado}</p>
                `;
                dayEventsList.appendChild(li);
            });
        }
        openModal(dayEventsModal);
    }

    prevMonthBtn.addEventListener('click', () => {
        calendarDate.setMonth(calendarDate.getMonth() - 1);
        renderCalendar();
    });
    nextMonthBtn.addEventListener('click', () => {
        calendarDate.setMonth(calendarDate.getMonth() + 1);
        renderCalendar();
    });
    calendarGrid.addEventListener('click', e => {
        const target = e.target.closest('.calendar-day.has-events');
        if (target && target.dataset.date) {
            showDayEvents(target.dataset.date);
        }
    });
    closeDayEventsBtn.addEventListener('click', () => closeModal(dayEventsModal));

    // ---------- INICIALIZACI√ìN DE DATOS DESDE FIRESTORE ----------
    function initialize() {
        if (!currentUserId) return;
        
        // Detener listeners anteriores si existen
        if (unsubContactos) unsubContactos();
        if (unsubCasos) unsubCasos();
        if (unsubVencimientos) unsubVencimientos();
        if (unsubFacturacion) unsubFacturacion();
        if (unsubTareas) unsubTareas();

        // Listener para Contactos
        const contactosRef = collection(db, `users/${currentUserId}/contactos`);
        unsubContactos = onSnapshot(contactosRef, (snapshot) => {
            contactos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderContactos();
            updateCasesView(); // Actualizar car√°tulas en casos
        });

        // Listener para Casos
        const casosRef = collection(db, `users/${currentUserId}/casos`);
        unsubCasos = onSnapshot(casosRef, (snapshot) => {
            casos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateCasesView();
        });

        // Listener para Vencimientos
        const vencimientosRef = collection(db, `users/${currentUserId}/vencimientos`);
        unsubVencimientos = onSnapshot(vencimientosRef, (snapshot) => {
            vencimientos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderVencimientos();
            renderDashboard();
            renderCalendar();
        });

        // Listener para Facturaci√≥n
        const facturacionRef = collection(db, `users/${currentUserId}/facturacion`);
        unsubFacturacion = onSnapshot(facturacionRef, (snapshot) => {
            facturacion = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderFacturacion();
        });
        
        // Listener para Tareas
        const tareasRef = collection(db, `users/${currentUserId}/tareas`);
        unsubTareas = onSnapshot(tareasRef, (snapshot) => {
            tareas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTareas();
            renderDashboard();
            renderCalendar();
        });

        switchTab('dashboard');
    }

  </script>
</body>
</html>
